# å•é¡µæ‹›è˜åº”ç”¨é¡¹ç›®appã€P40~ã€‘

### ã€2019-8-3  09:26:00ã€‘ä»Šæ—¥è®¡åˆ’ï¼šP40-P50

[TOC]



## æ­å»ºæ•´ä½“ç•Œé¢

## ç”¨æˆ·æ³¨å†Œ/ç™»é™†å¹¶å®Œå–„ä¿¡æ¯ä¹‹åï¼Œè¿›å…¥çš„ç•Œé¢ã€‚

åŠŸèƒ½ï¼š

- åº•éƒ¨åˆ‡æ¢æŒ‰é’®ï¼Œä¸åŒçš„æŒ‰é’®å¯ä¸€åˆ‡æ¢åˆ°ä¸åŒçš„è·¯ç”±ç»„ä»¶ç•Œé¢ã€‚æ ¹æ®ä¸åŒçš„ç±»å‹ï¼Œå‘ˆç°ç›¸åº”çš„ç»„ä»¶é¡µé¢ã€‚

- å®ç°è‡ªåŠ¨ç™»å½•çš„åŠŸèƒ½ã€é€šè¿‡cookieå®ç°ã€‚cookieå½“ä¸­ä¿å­˜æœ‰ç”¨æˆ·id->useridã€‘ã€‚useridé€šè¿‡å‘é€è¯·æ±‚å¾—åˆ°ã€‚

  1.å®ç°è‡ªåŠ¨ç™»å½•ã€‚å¦‚æœcookieä¸­æœ‰useridï¼Œå°±è‡ªåŠ¨ç™»å½•ã€‚è¦å®ç°è‡ªåŠ¨ç™»å½•ï¼Œå°±éœ€è¦å‘è¯·æ±‚ï¼Œè·å–å¯¹åº”çš„user
  2.å¦‚æœcookieä¸­æ²¡æœ‰useridï¼Œå°±è¿›å…¥loginç•Œé¢ã€‚
  3.å¦‚æœå·²ç»ç™»é™†äº†ï¼Œé‚£ä¹ˆå°±åˆ¤æ–­æ˜¯è¿›å…¥å®Œå–„ä¿¡æ¯çš„è·¯ç”±ï¼Œè¿˜æ˜¯è¿›å…¥ä¸»ç•Œé¢è·¯ç”±ã€‚
  å¦‚æœè¯·æ±‚æ ¹è·¯å¾„ï¼Œå°±æ ¹æ®typeå’Œheaderæ¥è®¡ç®—å‡ºä¸€ä¸ªé‡å®šå‘çš„è·¯å¾„ï¼Œè‡ªåŠ¨é‡å®šå‘

- ä¸»é¡µé¢é¡¹ç›®æ­å»ºï¼šåœ¨containers/main/main.jsxå½“ä¸­å®Œæˆ

  - è¯»å–cookieä¸­çš„useridï¼šå¯åŸç”Ÿï¼Œä¹Ÿå¯åŠ è½½ä¾èµ–åŒ…:

    ```
    sudo cnpm install js-cookie -S
    ```

    js-cookieåº“æä¾›äº†ä¸€ä¸ªCookieså¯¹è±¡ï¼Œè¿™æ˜¯ä¸€ä¸ªå¯ä»¥æ“ä½œå‰ç«¯cookieçš„å¯¹è±¡ã€‚æä¾›set()/get()/remove()ç­‰æ–¹æ³•.

    githubåœ°å€ï¼š[js-cookie GitHubåœ°å€](https://github.com/js-cookie/js-cookie)

    ```javascript
    //containers/main/main.jsx
    
    import Cookies from "js-cookie";
    import { getRedirectTo } from "../../utils";
    
        //è¯»å–cookieä¸­userid
    		const userid = Cookies.get('userid');
    		//å¦‚æœæ²¡æœ‰ï¼Œè‡ªåŠ¨é‡å®šå‘åˆ°ç™»é™†ç•Œé¢
    		if (!userid) {
    			return <Redirect to="/login" />
    		}
    		//å¦‚æœæœ‰ï¼Œè¯»å–reduxä¸­çš„userçŠ¶æ€ã€‚
    		const { user } = this.props;
    		//å¦‚æœreduxä¸­userçŠ¶æ€é‡Œæ²¡æœ‰_idï¼Œä¸èƒ½è·³è½¬ç™»é™†ç•Œé¢ï¼Œè€Œæ˜¯è¿”å›ä¸€ä¸ªnullï¼Œä¸åšä»»ä½•æ˜¾ç¤º
    		if (!userid) {
    			return null
    		}else{//å¦‚æœreduxä¸­userçŠ¶æ€é‡Œæœ‰_idï¼Œæ˜¾ç¤ºå¯¹åº”çš„ç•Œé¢
    			const path = this.props.location.pathname;
    			if (path === '/') {//å¦‚æœè¯·æ±‚æ ¹è·¯å¾„ï¼Œå°±æ ¹æ®typeå’Œheaderæ¥è®¡ç®—å‡ºä¸€ä¸ªé‡å®šå‘çš„è·¯å¾„ï¼Œè‡ªåŠ¨é‡å®šå‘
    				//å¾—åˆ°ä¸€ä¸ªé‡å®šå‘çš„è·¯ç”±è·¯å¾„
    				getRedirectTo(user.type, user.header);
    				return <Redirect to={} />
    			}
    		}
    
    ```

  ç”¨Cookies.get("userid")æ—¶æŠ¥é”™ï¼š

  ![Snip20190803_1](/Users/luofei/Pictures/Snip20190803_1.png)

åŸå› ï¼šåœ¨main.jsxæ–‡ä»¶é‡Œå¼•å…¥Cookiesçš„æ—¶å€™é”™è¯¯å¼•ç”¨äº†ã€‚æ­£ç¡®çš„æ ¼å¼åº”è¯¥æ˜¯ï¼š

```javascript
import Cookies from "js-cookie";
```

âœ…ï¼šä¸»ç•Œé¢çš„ç¼–å†™å®Œæˆã€‚

### æœåŠ¡å™¨ç«¯è·¯ç”±ï¼š

```javascript
//åç«¯é¡¹ç›®æ–‡ä»¶/routers/index.js

//è·å–ç”¨æˆ·ä¿¡æ¯çš„è·¯ç”±ï¼Œæ ¹æ®useridè·å–
router.get('/user', function(req,res){
	const userid = req.cookies.userid;
	if (!userid) {
		return res.send({code:1, msg:"è¯·å…ˆç™»é™†"})
	}
	//æ ¹æ®useridæŸ¥è¯¢å¯¹åº”çš„user
	UserModel.findOne({_id: userid}, filter, function(error,user){
		res.send({code:0, data:user});
	})
})
```

### å‰ç«¯apiï¼š

```javascript
//å‰ç«¯é¡¹ç›®æ–‡ä»¶/src/api/index

//è·å–ç”¨æˆ·ä¿¡æ¯
export const reqUser = ()=> ajax('/user')
```

### è·å–ç”¨æˆ·ä¿¡æ¯çš„å¼‚æ­¥action

```javascript
//å‰ç«¯é¡¹ç›®æ–‡ä»¶/src/redux/actions

//è·å–ç”¨æˆ·çš„å¼‚æ­¥action: getUser()
export const getUser = () => {
	return async dispatch => {
		//æ‰§è¡Œå¼‚æ­¥ajaxè¯·æ±‚
		const response = await reqUser(); //reqUser()æ˜¯ä¸€ä¸ªajaxè¯·æ±‚ï¼Œè¯·æ±‚ç»“æœåŒ…æ‹¬{code: xx, data:{}}
		const result = response.data;
		if (result.code === 0) {
			//æˆåŠŸè·å–æ•°æ®
			dispatch(receiveUser(result.data));
		}else{
			//è·å–æ•°æ®å¤±è´¥
			dispatch(resetUser(result.msg))
		}
	}
}
```

### å›åˆ°å‰ç«¯é¡¹ç›®ä»£ç /src/containers/main/main.jsx

```javascript
//src/containers/main/main.jsx

import { getUser } from "../../redux/actions"

//ç»„ä»¶é‡Œçš„componentDidMount()å‡½æ•°
componentDidMount(){
		const userid = Cookies.get('userid');
		const { _id } = this.props.user;
		if (userid && !_id) { //ç™»é™†è¿‡ï¼Œæ‰€ä»¥æœ‰useridï¼›ç°åœ¨æ²¡æœ‰ç™»é™†ï¼Œæ‰€ä»¥æ²¡æœ‰_id
			//å‘é€å¼‚æ­¥è¯·æ±‚ï¼Œè·å–userã€å…ˆå†™ajax->å†å†™redux->å†å†™è¿™ä¸ªç»„ä»¶ã€‘
			this.props.getUser() //ä¸éœ€è¦ä¼ å…¥å‚æ•°
		}
	}

export default connect(
	state => ({user: state.user}),
	{ getUser } //å°†getUserä¼ åˆ°å½“å‰çš„UIç»„ä»¶
	)(Main)

```

### å‰ç«¯è·¯ç”±ç»„ä»¶ã€‚

ä¸€èˆ¬éƒ½è¦è·Ÿreduxäº¤äº’ï¼Œæ‰€ä»¥ä¸€èˆ¬éƒ½æ”¾åœ¨containersæ–‡ä»¶å¤¹é‡Œã€‚

- åˆ›å»ºå››ä¸ªéœ€è¦å’Œreduxäº¤äº’çš„æ–‡ä»¶å¤¹ï¼š
  - containers/laoban/laoban.jsx
  - containers/dashen/dashen.jsx
  - containers/message/message.jsx
  - containers/personal/personal.jsx

- 404ç•Œé¢ã€‚è¿™ä¸ªç•Œé¢ä¸éœ€è¦è·Ÿreduxäº¤äº’ã€‚
  - components/not-found

é¦–å…ˆå†™404ç•Œé¢ï¼š

```javascript
//404é¡µé¢ï¼Œæ‰¾ä¸åˆ°é¡µé¢çš„æ—¶å€™è¿”å›åˆ°è¿™é‡Œã€‚

import React, {Component} from "react";
import { Button } from "antd-mobile"

//å¤§ç¥ç•Œé¢è·¯ç”±å®¹å™¨ä¸»
export default class NotFound extends Component{
	render(){
		return (
			<div>
				<div>
					<h2>æŠ±æ­‰ï¼Œæ‰¾ä¸åˆ°è¯¥é¡µé¢ï¼</h2>
					<Button type="primary" 
					onClick={ ()=>this.props.history.replace('/') }>å›åˆ°é¦–é¡µ</Button>
				</div>
			</div>
			)
	}
}
```

å†å°†å…¶æ˜ å°„åˆ°main.jsxæ–‡ä»¶å½“ä¸­

```javascript
//containers/main/main.jsx
import Dashen from "../dashen/dashen";
import Laoban from "../laoban/laoban";
import Message from "../message/message";
import Personal from "../personal/personal";
import NotFound from "../../components/not-found/not-found";

...

<Switch>
				<Route path="/dasheninfo" component={ DashenInfo } />
				<Route path="/laobaninfo" component={ LaobanInfo } />
				<Route component={ Laoban } />
</Switch>
```

æ¯ä¸ªè·¯ç”±é‡ŒåŒ…å«é‡Œäº”éƒ¨åˆ†ä¿¡æ¯ï¼šè·¯ç”±è·¯å¾„ã€è·¯ç”±ç»„ä»¶ã€åº•éƒ¨å¯¹åº”çš„å›¾æ ‡ã€å›¾æ ‡å¯¹åº”çš„æ–‡å­—ã€é¡¶éƒ¨æ ‡é¢˜ï¼Œè€æ¿/å¤§ç¥çš„è¿™äº”ä¸ªéƒ¨åˆ†ä¿¡æ¯ä¸åŒï¼Œå…¶å®ƒéƒ¨åˆ†ç•Œé¢ç»„æˆç›¸åŒã€‚

- åœ¨main.jsxé‡Œå¼•å…¥è¿™éƒ¨åˆ†ä¿¡æ¯

```javascript
class Main extends Component{
	//ä¸åŠ staticæ˜¯ç»™ç»„ä»¶å¯¹è±¡æ·»åŠ å±æ€§ï¼ŒåŠ staticæ˜¯ç»™ç»„ä»¶ç±»æ·»åŠ å±æ€§
	navList = [ //åŒ…å«æ‰€æœ‰å¯¼èˆªç»„ä»¶çš„ç›¸å…³æ•°æ®ä¿¡æ¯ã€‚
	{
		path: "/laoban",
		component: Laoban,
		title: "å¤§ç¥åˆ—è¡¨",
		icon: "dashen", //
		text: "å¤§ç¥"
	},
	{
		path:"/dashen",
		component: Dashen,
		title: "è€æ¿åˆ—è¡¨",
		icon: "laoban",
		text: "è€æ¿"
	},
	{
		path: "/message",
		component: Message,
		title:"æ¶ˆæ¯åˆ—è¡¨",
		icon: "message",
		text: "æ¶ˆæ¯"
	},
	{
		path: "/personal",
		component: Personal,
		title: "ç”¨æˆ·ä¸­å¿ƒ",
		icon: "personal",
		text: "ä¸ªäºº"
	}
	]
```

- æ˜ å°„è·¯ç”±

  æ¯ä¸ªmainè·¯ç”±ä¸‹é¢çš„å­è·¯ç”±éƒ½æ˜¯ä¸Šã€ä¸­ã€ä¸‹çš„ç»“æ„ï¼ŒåŒ…æ‹¬é¡¶éƒ¨æ ‡é¢˜ã€ä¸­é—´æ˜¯å››ä¸ªå¯¼èˆªè·¯ç”±ç»„ä»¶æ˜¾ç¤ºçš„éƒ¨åˆ†ï¼Œåº•éƒ¨

```javascript
	const  { navList }= this;
		const path = this.props.location.pathname;//è¯·æ±‚çš„è·¯å¾„
		const currentNav = navList.find(nav => nav.path === path) //æ•°ç»„æŸ¥æ‰¾å…ƒç´ ç”¨find()æ–¹æ³•.navListå½“ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ªnavï¼Œæˆ‘ä»¬éœ€è¦å¯¹æ¯”navä¸‹çš„pathæ˜¯ä¸æ˜¯ç­‰äºå½“å‰çš„path 
		//find()ä¸­å¦‚æœä¸ºtrueï¼Œå¾—åˆ°é¦–ä¸ªåŒ¹é…é¡¹ã€‚
		return (<div>
					{ currentNav ? <NavBar>{ currentNav.title }</NavBar> : null}
					<Switch>
					{
						navList.map(nav => <Route path={nav.path} component={nav.component} />) //æ˜ å°„äº†å››ä¸ªè·¯ç”±
					}
						<Route path="/dasheninfo" component={ DashenInfo } />
						<Route path="/laobaninfo" component={ LaobanInfo } />
						<Route component={ Laoban } />
					</Switch>
					{ currentNav ? <div></div> : null} {/*<div></div>æš‚æ—¶å ä½ï¼Œè¿™æ˜¯åº•éƒ¨å¯¼èˆªï¼Œéœ€è¦å•ç‹¬æŠ½å–å‡ºæ¥ã€‚*/}
				</div>)
```

- å®šä¹‰åº•éƒ¨å¯¼èˆªã€åº•éƒ¨å¯¼èˆªä¸éœ€è¦å’Œreduxè¿›è¡Œäº¤äº’ã€‘

  - å®šä¹‰åœ¨components/nav-footer/nav-footer.jsx

  - âš ï¸const path = this.props.location.pathnameï¼šè·¯ç”±ç»„ä»¶æ‰æœ‰è¿™ä¸ªå†™æ³•ï¼Œnav-footer.jsxç»„ä»¶æ˜¯éè·¯ç”±ç»„ä»¶ï¼Œå› æ­¤pathä¸èƒ½ç”¨è¿™ä¸ªæ–¹å¼è·å–ã€‚
  - å¦‚æœå¸Œæœ›åœ¨éè·¯ç”±ç»„ä»¶ä¸­ä½¿ç”¨è·¯ç”±åº“çš„apiï¼Œå¯ä»¥ä½¿ç”¨è·¯ç”±ç»„ä»¶åº“çš„ä¸€ä¸ªå‡½æ•°withRoute()ï¼Œå®ƒå¯ä»¥å¯¹å½“å‰ç»„ä»¶è¿›è¡ŒåŒ…è£…ï¼Œè¿”å›åŒ…è£…åçš„ç»„ä»¶ã€‚

  ```javascript
  //components/nav-footer/nav-footer.jsx
  
  import React, { Component } from "react";
  import { TabBar } from "antd-mobile";
  import PropTypes from "prop-types";
  import { withRouter } from "react-router-dom";
  
  const Item = TabBar.Item
  
  //åº•éƒ¨å®¹å™¨
  class NavFooter extends Component{
  	static propTypes = {
  		navList: PropTypes.array.isRequired
  	}
  	render(){
  		const { navList } = this.props;
  		const path = this.props.location.pathname; //è·¯ç”±ç»„ä»¶æ‰æœ‰è¿™ä¸ªå†™æ³•ï¼Œè¿™ä¸ªç»„ä»¶æ˜¯è·¯ç”±ç»„ä»¶ï¼Œå› æ­¤pathä¸èƒ½ç”¨è¿™ä¸ªæ–¹å¼è·å–
  		//å¸Œæœ›åœ¨éè·¯ç”±ç»„ä»¶ä¸­ä½¿ç”¨è·¯ç”±åº“çš„apiï¼Œå¯ä»¥ä½¿ç”¨è·¯ç”±ç»„ä»¶åº“çš„ä¸€ä¸ªå‡½æ•°withRoute()ï¼Œ
  		//å¯¹å½“å‰ç»„ä»¶è¿›è¡ŒåŒ…è£…ï¼Œè¿”å›åŒ…è£…åçš„ç»„ä»¶
  		return (
  			<TabBar >{ navList.map((nav) => (
  				<Item 
  				key={nav.path}
  				title={nav.text}
  				icon={{uri:require(`./images/${nav.icon}.png`)}} 
  				//ç¬¬ä¸€å±‚{}è¡¨ç¤ºè¦å†™jsè¡¨è¾¾å¼ï¼Œç¬¬äºŒå±‚{}è¡¨ç¤ºè¦å†™å¯¹è±¡ï¼Œ``è¡¨ç¤ºå†™çš„æ˜¯ä¸€ä¸ªæ¨¡ç‰ˆå­—ç¬¦ä¸²
  				selectedIcon={{uri:require(`./images/${nav.icon}-selected.png`)}}
  				selected={ path === nav.path}
  				onPress={()=>this.props.history.replace(nav.path)}
  				tabBarPosition="bottom"></Item>
  				)
  			)
  		}</TabBar>)
  	}
  }
  
  //å†…éƒ¨ä¼šå‘ç»„ä»¶ä¸­ä¼ å…¥ä¸€äº›è·¯ç”±ç»„ä»¶ç‰¹æœ‰çš„å±æ€§ï¼šhistory/location/math
  export default withRouter(NavFooter); //å‘å¤–æš´éœ²withRouter()åŒ…è£…äº§ç”Ÿçš„ç»„ä»¶
  ```

  mainä¸­ä¿å­˜äº†å››ä¸ªäºŒçº§è·¯ç”±ï¼Œä½†æœ‰ä¸€ä¸ªç»„ä»¶éœ€è¦è¢«åŠ¨æ€éšè—ã€‚ç»™å…¶ä¸­ä¸€ä¸ªç»„ä»¶æ·»åŠ éšè—ä¿¡æ¯ã€‚å“ªä¸ªç»„ä»¶è¢«éšè—æ ¹æ®ç”¨æˆ·ç±»å‹å†³å®šã€‚å¦‚æœå½“å‰ç”¨æˆ·ç±»å‹æ˜¯â€œlaobanâ€ï¼Œé‚£ä¹ˆå°±éšè—â€œdashenâ€ç»„ä»¶ã€‚

  nav-footer.jsxç»„ä»¶ç”¨withRouteråŒ…è£…å¹¶å¯¼å‡ºï¼Œå¯ç”¨propsæ¥æ”¶çˆ¶ç»„ä»¶çš„å±æ€§

  ```javascript
  //nav-footer.jsx
  
  let { navList } = this.props; //ä»çˆ¶ç»„ä»¶å½“ä¸­è·å–navList
  //è¿‡æ»¤æ‰hideä¸ºtrueçš„nav
  navList = navList.filter(nav => !nav.hide)
  ```

## ä¸ªäººä¸­å¿ƒåŠŸèƒ½é¡µé¢çš„ç¼–å†™ï¼š

containers/personal/personal.jsx

- ä½¿ç”¨antd-mobileé‡Œçš„UIç»„ä»¶

  ```javascript
  import { Result, List, Button, WhiteSpace } from "antd-mobile";
  ```

- ç”¨connectå°†ç»„ä»¶åŒ…è£…æˆå®¹å™¨ç»„ä»¶

  ```javascript
  export default connect(
  	state => ({user: state.user}),
  	{}
  	)(Personal);
  ```

- é¡µé¢ç»“æ„ï¼š

  ```javascript
  class Personal extends Component{
  	render(){
  		const { username, header, company, post, salary, info } = this.props.user
  		return (
  			<div>
  				<Result 
  					img={<img src={require(`../../assets/images/${header}.png`)} style={{width:50}} alt="header"/>} title={username} message={company} />
  				<List renderHeader={ ()=> "ç›¸å…³ä¿¡æ¯" }>
  					<Item multipleLine> 
  						<Brief>èŒä½ï¼š{post}</Brief>
  						<Brief>ç®€ä»‹ï¼š{info}</Brief>
  						{salary ? <Brief>è–ªèµ„ï¼š{salary}</Brief> : null}
  					</Item>
  				</List>
  				<WhiteSpace/>
  				<List>
  					<Button type="warning">é€€å‡ºç™»å½•</Button>
  				</List>
  			</div>)
  	}
  }
  ```

- é€€å‡ºç™»å½•åŠŸèƒ½çš„ç¼–å†™

  ```
  <Button type="warning" onClick={this.loginOut}>é€€å‡ºç™»å½•</Button>
  ```

  âŒï¼šç‚¹å‡»â€œé€€å‡ºâ€æŒ‰é’®æ—¶ï¼ŒæŒ‰é’®æ²¡æœ‰æ ·å¼ä¸Šçš„ä»»ä½•ååº”ã€‚

  ğŸ““ï¼šåŸå› æ˜¯åº•éƒ¨å¯¼èˆªçš„é«˜åº¦100%ï¼Œè¦†ç›–äº†æ•´ä¸ªé¡µé¢ã€‚å¯¼è‡´ç‚¹å‡»ä¸åˆ°é€€å‡ºæŒ‰é’®ã€‚

  ğŸ“’ï¼šè§£å†³åŠæ³•ï¼šéœ€è¦ä¿®æ”¹assets/css/index.lessæ–‡ä»¶é‡Œçš„`.am-tab-bar`æ ·å¼ï¼Œè®¾ç½®`height:inherit;`

- è¦å®ç°ç‚¹å‡»â€œé€€å‡ºç™»å½•â€æŒ‰é’®ï¼Œè·³å‡ºç¡®è®¤æ¡†ï¼Œè·³è½¬åˆ°ç™»é™†ç•Œé¢ä¸Šçš„åŠŸèƒ½ï¼Œéœ€è¦ä¸€ä¸ªå¯¹è¯æ¡†ç»„ä»¶ï¼šModalã€‚Modalç»„ä»¶ç”±antd-mobileæä¾›ï¼Œå®ƒæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œä¸æ˜¯ä¸€ä¸ªæ ‡ç­¾ã€‚Modalç»„ä»¶æœ‰ä¸€ä¸ªalertæ–¹æ³•ï¼Œæ¥æ”¶ä¸‰ä¸ªå‚æ•°ï¼ŒModal.alert("é€€å‡º", "ç¡®è®¤é€€å‡ºç™»å½•å—ï¼Ÿ", [{},{}])ï¼Œå‰ä¸¤ä¸ªæ˜¯æè¿°ï¼Œç¬¬ä¸‰ä¸ªæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„ç¬¬ä¸€ä¸ªå…ƒç´ æè¿°ç¬¬ä¸€ä¸ªæŒ‰é’®ï¼Œç¬¬äºŒä¸ªå…ƒç´ æè¿°ç¬¬äºŒä¸ªæŒ‰é’®ã€‚

- å¦‚æœä¸éœ€è¦è·Ÿåå°é€šä¿¡ï¼Œé‚£ä¹ˆå°±ç”¨åŒæ­¥actionã€‚resetuserå¯ä»¥ä½¿ç”¨æˆ·çŠ¶æ€å›åˆ°åˆå§‹çŠ¶æ€ã€‚

  ```javascript
  logOut = ()=>{
  		Modal.alert("é€€å‡º", "ç¡®è®¤é€€å‡ºç™»å½•å—ï¼Ÿ", [
  			{
  				text: "å–æ¶ˆ",
  			},
  			{
  				text: "ç¡®è®¤",
  				onPress : ()=>{
  					//ç§»é™¤cookieä¸­çš„userid
  					Cookies.remove("userid");
  					//ç§»é™¤reduxé‡Œç®¡ç†çš„userid
  					this.props.resetUser()
  				}
  			}])
  	}
  ```

âœ…ï¼šâ€œä¸ªäººä¸­å¿ƒâ€è·¯ç”±ç•Œé¢çš„ä»£ç ç¼–å†™å®Œæˆ

## è€æ¿/å¤§ç¥åˆ—è¡¨åŠŸèƒ½çš„ç¼–å†™

containers/laoban/laoban.jsx; 

#### containers/dashen/dashen.jsx 

ä¸¤ä¸ªåˆ—è¡¨åŠŸèƒ½ç±»ä¼¼ï¼Œå¯ä»¥æŠ½å–å‡ºä¸€ä¸ªç»„ä»¶ï¼Œç”¨æ¥å±•ç¤ºç›¸åŒçš„ç»“æ„ã€‚åªè¦æ ¹æ®ç±»åˆ«å¾€é‡Œé¢å¡«å……ä¸åŒåŠŸèƒ½å°±å¯ä»¥äº†ã€‚å› æ­¤æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç”¨æˆ·åˆ—è¡¨ç»„ä»¶ï¼šcomponents/user-list/user-list.jsx

- éœ€è¦ç¼–å†™å±•ç¤ºå¤§ç¥/è€æ¿åˆ—è¡¨çš„é™æ€UIç»„ä»¶ã€‚éœ€æ±‚ï¼šä»åå°è·å–æŒ‡å®šç”¨æˆ·ç±»å‹çš„åˆ—è¡¨ï¼Œæ¸²æŸ“åˆ°é¡µé¢ä¸Š

- é¦–å…ˆç¼–å†™åå°è·¯ç”±routes/index.js

- ```javascript
  //æ ¹æ®typeè·å–å¯¹åº”çš„ç”¨æˆ·åˆ—è¡¨
  router.get('/userlist',function(req,res){
  	const { type } = req.query;
  	UserModel.find({type}, filter, function(error, users){
  		res.send({code: 0, data: users});
  	})
  })
  ```

- åå°è·¯ç”±ç¼–å†™å¥½ä¹‹åï¼Œåœ¨postmanè¿›è¡Œæ¥å£çš„è°ƒè¯•ã€‚é€‰æ‹©â€œGETâ€ç±»å‹ï¼Œâ€œparamsâ€ç±»å‹è¿›è¡Œæµ‹è¯•ã€‚

  âœ…ï¼šå±•ç¤ºå¤§ç¥/è€æ¿åˆ—è¡¨çš„åå°è·¯ç”±æ¥å£ç¼–å†™å®Œæˆï¼ŒåŠŸèƒ½ä¸ºæ ¹æ®typeè·å–å¯¹åº”çš„ç”¨æˆ·åˆ—è¡¨

  ------

- å‰å°apiçš„ç¼–å†™ã€‚æ ¹æ®æ¥å£æ–‡æ¡£å»å®šä¹‰æ¥å£è¯·æ±‚å‡½æ•°

  ```javascript
  //src/api/index.js
  export const reqUserList = (type)=> ajax("/userlist", {type}, "GET");//è¯·æ±‚æ–¹å¼ä¸º"GET"æ—¶å¯çœç•¥
  ```

- userListéœ€è¦ç”¨reduxè¿›è¡Œç®¡ç†ï¼Œå› æ­¤éœ€è¦ç¼–å†™redux

  ```javascript
  //action-types
  export const RECEIVE_USER_LIST = "receive_user_list";
  //ä¹‹å‰çš„actionéƒ½æ˜¯åœ¨æ“ä½œuserï¼Œæ­¤actionæ˜¯æ“ä½œuser-list çš„ï¼Œå› æ­¤éœ€è¦å®šä¹‰å¯¹åº”çš„reducer
  ```

  ```javascript
  //reducer
  //äº§ç”ŸuserlistçŠ¶æ€çš„reducer
  //é€šè¿‡dispatchå¯¹åº”çš„actionæ¥ä¿®æ”¹çŠ¶æ€ï¼Œè€ŒçŠ¶æ€çš„ä¿®æ”¹ç»Ÿä¸€é€šè¿‡reduceræ¥å®Œæˆã€‚
  const initUserList = []
  function userList(state=initUserList, action){
  	switch(action.type){
  		case REVEIVE_USER_LIST: //dataä¸ºuserList
        return action.data
  		default:
  		return state
  	}
  }
  ```

  ```javascript
  //action
  
  //æ¥æ”¶ç”¨æˆ·åˆ—è¡¨çš„åŒæ­¥action
  export const receiveUserList = (userList)=>({type: REVEIVE_USER_LIST, data: userList});
  
  //è·å–ç”¨æˆ·åˆ—è¡¨çš„å¼‚æ­¥action
  export const getUserList = (type)=>{
  	return async dispatch =>{
  		//æ‰§è¡Œå¼‚æ­¥ajaxè¯·æ±‚
  		const response = await reqUserList(type) //reqUserListæ˜¯ä¸€ä¸ªajaxè¯·æ±‚
  		const result = response.data;//responseæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œæ ¼å¼ä¸º{code: 0, data: users}
  		//å¾—åˆ°ç»“æœä¹‹ååˆ†å‘ä¸€ä¸ªåŒæ­¥action
  		if (result.code === 0) {
  			dispatch(receiveUserList(result.data));
  		}
  	}
  }
  ```

  âœ…ï¼šè·å–ç”¨æˆ·åˆ—è¡¨çš„reduxéƒ¨åˆ†ä»£ç å®Œæˆ

  ------

  ### ã€2019-8-4 09:09:00ã€‘

  é¡¹ç›®æ‰“å¼€æµç¨‹ï¼š

  ```
  æ•°æ®åº“mongodbï¼Œæ‰§è¡Œmongodå‘½ä»¤ï¼›
  åç«¯åº”ç”¨é¡¹ç›®ï¼Œæ‰§è¡Œ npm start å‘½ä»¤
  å‰ç«¯åº”ç”¨é¡¹ç›®ï¼Œæ‰§è¡Œ npm start å‘½ä»¤
  ```

- ä¸¤ä¸ªç”¨æˆ·åˆ—è¡¨ç»„ä»¶ï¼šè€æ¿/å¤§ç¥ï¼Œæ ¹æ®typeå®šä¹‰ä¸åŒåˆ—è¡¨ã€‚ä½†æ˜¯åˆ—è¡¨ç»“æ„æ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥å¯ä»¥æŠ½è±¡æˆä¸€ä¸ªç»„ä»¶ã€‚

  - æ–°å»ºcomponnets/users-list/user-list.jsx

    ```javascript
    //æ˜¾ç¤ºæŒ‡å®šç”¨æˆ·åˆ—è¡¨çš„UIç»„ä»¶
    //éœ€è¦æ¥æ”¶ä¸€ä¸ªuser-listå¯¹è±¡
    import React, { Component } from "react";
    // import { connect } from "react-redux";
    import PropTypes from "prop-types";
    import { WingBlank, Card, WhiteSpace } from "antd-mobile";
    const Header = Card.Header;
    const Body = Card.Body;
    
    export default class UserList extends Component{
    	static propTypes = {
    		userList: PropTypes.array.isRequired //æ¥æ”¶ä¸€ä¸ªuserList
    	}
    	render(){
    		const { userList } =this.props;
    		return (
    			<WingBlank>
    			{ userList.map(user =>(
    				<div key={user._id}>
    					<WhiteSpace />
    
    					<Card>
    						<Header thumb={require(`../../assets/images/${user.header}.png`)} extra="username"></Header>
    						<Body>
    							<div>èŒä½ï¼š{user.post}</div>
    							{user.company ? <div>å…¬å¸ï¼š{user.company}</div> : null}
    							{user.salary ? <div>æœˆè–ªï¼š{user.salary}</div> : null}
    							<div>æè¿°ï¼š{user.info}</div>
    						</Body>
    					</Card>
    				</div>
    				)
    			)}
    			</WingBlank>
    			)
    	}
    }
    ```

    æ¸²æŸ“ç•Œé¢çš„æ—¶å€™é‡åˆ°bugï¼š![Snip20190804_2](/Users/luofei/Pictures/Snip20190804_2.png)

æŠ¥é”™ï¼š![Snip20190804_3](/Users/luofei/Pictures/Snip20190804_3.png)

æœ€åå‘ç°æ˜¯åœ¨api/ajax.jsæ–‡ä»¶ä¸­çš„substringæ–¹æ³•æ‹¼å†™é”™è¯¯ï¼Œå†™æˆäº†subStringäº†ã€‚

ã€2019-8-4 13:20:00ã€‘

âœ… bugä¿®å¤

### å®Œå–„åˆ—è¡¨é¡µé¢æ˜¾ç¤º:

âŒï¼šæœ€åä¸€è¡Œçš„æ˜¾ç¤ºä¼šè¢«åº•éƒ¨å¯¼èˆªæ æŒ¡ä½ã€‚

ğŸ““ï¼šç»™åˆ—è¡¨æ‰€åœ¨tagåŠ styleï¼š

```html
<WingBlank style={{marginBottom: 50}}>
```

âŒå¤´éƒ¨ä¼šéšç€é¡µé¢æ»šåŠ¨è€Œæ»šåŠ¨ï¼Œæˆ‘ä»¬éœ€è¦å®ƒå›ºå®š.åŠ style={{marginBottm:50, marginTop:50}}å³å¯è§£å†³é—®é¢˜

âœ…ï¼š ä¿¡æ¯åˆ—è¡¨å®Œæˆ

### å®ç°å®æ—¶èŠå¤©åŠŸèƒ½

1. ä¸‹è½½ç›¸å…³ä¾èµ–åŒ…ï¼šå‰å°åº”ç”¨å’Œåå°åº”ç”¨éƒ½éœ€è¦ä¸‹è½½

   ```
   $ sudo cnpm install socket.io -S
   ```

   - è¿™æ˜¯ä¸€ä¸ªèƒ½å®ç°å¤šäººè¿œç¨‹å®æ—¶é€šä¿¡ã€èŠå¤©ã€‘çš„åº“;

   - å®ƒåŒ…è£…çš„æ˜¯**H5 WebSocket**ã€ä½¿ç”¨çš„æ˜¯wsåè®®ï¼Œè¯­æ³•ws://ã€‚httpåè®®åªèƒ½å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚ï¼Œä¸èƒ½å®ç°æœåŠ¡å™¨å‘æµè§ˆå™¨å‘é€è¯·æ±‚ã€‚wsåè®®å¯ä»¥å®ç°å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯äº’ç›¸å‘é€è¯·æ±‚ã€‘å’Œ**è½®è¯¢**ã€æµè§ˆå™¨æ¯éš”ä¸€æ®µæ—¶é—´å‘æœåŠ¡å™¨å‘é€è¯·æ±‚ã€‘, å¦‚æœæ˜¯è¾ƒæ–°çš„æµè§ˆå™¨å†…éƒ¨ä½¿ç”¨WebSocketã€‚

     å¦‚æœæµè§ˆå™¨ä¸æ”¯æŒ, é‚£å†…éƒ¨å°±ä¼šä½¿ç”¨è½®è¯¢å®ç°å®æ—¶é€šä¿¡ 

   - socket.ioåŒ…å«ä¸¤ä¸ªåŒ…ï¼Œä¸€ä¸ªç”¨äºæœåŠ¡å™¨ç«¯çš„åŒ…ï¼Œå°±å«åšsocket.ioï¼›ä¸€ä¸ªç”¨äºå®¢æˆ·ç«¯çš„åŒ…ï¼Œå«åšsocket.io-client

2.  æœåŠ¡å™¨ç«¯åˆ›å»ºä¸€ä¸ªæµ‹è¯•æ–‡ä»¶socketIO/test.js

   æœåŠ¡å™¨ç«¯çš„ioæ˜¯å…¨å±€çš„ï¼Œio.emitä¿¡æ¯å‘é€ç»™æ‰€æœ‰è¿æ¥ä¸ŠæœåŠ¡å™¨çš„å®¢æˆ·ç«¯ï¼›socket.emitä¿¡æ¯å‘é€ç»™å½“å‰socketå¯¹åº”çš„å®¢æˆ·ç«¯

   ```javascript
   //   /socketIO/test.js
   module.exports = function (server){
   	//å¾—åˆ°IOå¯¹è±¡
   	const io = require('socket.io')(server); //å¼•ç”¨socket.ioåº“ï¼Œæ‰§è¡Œserverå‡½æ•°å¾—åˆ°io
   	//è§è¯†è¿æ¥ï¼ˆå½“æœ‰ä¸€ä¸ªå®¢æˆ·è¿æ¥ä¸Šæ—¶å›è°ƒï¼‰
   	io.on('connection', function(socket){ //è¿™é‡Œçš„onè¡¨ç¤ºè¿æ¥ä»»ä½•æµè§ˆå™¨ï¼šå®¢æˆ·ç«¯äº§ç”Ÿè¿æ¥çš„æ—¶å€™æ‰§è¡Œå›è°ƒå‡½æ•°
   		console.log('socketio connected');
   		//ç»‘å®šsendMsgç›‘å¬ï¼Œæ¥æ”¶å®¢æˆ·ç«¯å‘é€çš„æ¶ˆæ¯
   		socket.on('sendMsg', function(data){ //è¿æ¥çš„æ˜¯å½“å‰socketå¯¹åº”çš„å®¢æˆ·ç«¯ã€‚è¿™é‡Œçš„sendMsgå¯ä»¥ä»»æ„å‘½å
   			console.log('æœåŠ¡å™¨æ¥æ”¶åˆ°æµè§ˆå™¨çš„æ¶ˆæ¯', data);
   			//å‘å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯ï¼ˆåç§°ï¼Œæ•°æ®ï¼‰
   			io.emit('receiveMsg', data.name+'_'+data.data);//å‘é€ç»™æ‰€æœ‰è¿æ¥ä¸ŠæœåŠ¡å™¨çš„å®¢æˆ·ç«¯
   			//socket.emit('receiveMsg', data.name+'_'+data.data) å‘é€ç»™å½“å‰socketå¯¹åº”çš„å®¢æˆ·ç«¯
         console.log('æœåŠ¡å™¨å‘æµè§ˆå™¨å‘é€æ¶ˆæ¯',data);
   		})
   	})
   }
   
   //è¿™æ˜¯ä¸€ä¸ªå‡½æ•°ç±»å‹çš„æ¨¡å—
   ```

3. æœåŠ¡ç«¯çš„bin/wwwæ–‡ä»¶ä¸‹ï¼š

   ```
   //æ˜¯ä¸€ä¸ªå‡½æ•°ç±»å‹
   require('../socketIO/test')(server);// åŠ è½½åˆšæ‰å®šä¹‰çš„æ¨¡å—ã€‚è¿™æ˜¯ä¸€ä¸ªå‡½æ•°ç±»å‹
   ```

4. å®¢æˆ·ç«¯ src/test/socketio_test.js

   ```javascript
   //æ­¤æ¨¡å—æ²¡æœ‰å‘å¤–æš´éœ²ä»€ä¹ˆï¼Œæ‰§è¡Œå®ƒå°±è¡Œäº†ï¼Œè¦æƒ³è®©å®ƒæ‰§è¡Œï¼Œå¯ä»¥å¼•å…¥åˆ°å…¥å£jsæ–‡ä»¶ä¸Š
   import io from "socket.io-client"; 
   
   const socket = io('ws://localhost:4000');//è¿æ¥æŒ‡å®šçš„æœåŠ¡å™¨ç«¯ï¼Œ
   socket.on('receiveMsg', function(data){//ç»‘å®šç›‘å¬ï¼Œæ¥æ”¶æ•°æ®ï¼Œæ•°æ®ä»æœåŠ¡å™¨ç«¯å‘è¿‡æ¥
   	console.log('æµè§ˆå™¨ç«¯æ¥æ”¶åˆ°æ¶ˆæ¯',data);
   });
   
   socket.emit('sendMsg', {name: 'Tom', data: Date.now()});//emitåˆ†å‘æ¶ˆæ¯
   console.log('æµè§ˆå™¨ç«¯å‘æœåŠ¡å™¨å‘é€æ¶ˆæ¯:', {name: 'Tom', data:Date.now()})
   ```

5. socketio_testæ¨¡å—æ²¡æœ‰å‘å¤–æš´éœ²ï¼Œå› æ­¤æƒ³è¦æ‰§è¡Œï¼Œå¯ä»¥ç›´æ¥åœ¨å…¥å£jsæ–‡ä»¶é‡Œå¼•ç”¨ã€‚å…¥å£jsæ–‡ä»¶åŠ è½½æ‰€æœ‰ç›¸å…³çš„æ¨¡å—

   ```javascript
   //src/index.js
   import "./test/socketio_test";
   ```

### ã€2019-8-5 08:30:00 ã€‘ä»ç¬¬52èŠ‚ï¼šsocketioçš„ä»‹ç»å’Œç†è§£å¼€å§‹ã€‚

ä»Šæ—¥è®¡åˆ’ã€P52-P62ã€‘

1. æœåŠ¡å™¨ç«¯ä»£ç ï¼š

   ```javascript
   //socketIO/test.js
   
    //æ­¤å¤„çš„serveræ˜¯bin/wwwä¸­å£°æ˜çš„ï¼Œvar server = http.createServer(app);
   
   module.exports = function(server){
   	const io = require('socket.io')(server);
   	//ç›‘è§†å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨çš„é“¾æ¥
   	io.on('connection',function(socket){
   		console.log('æœ‰ä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥ä¸Šäº†æœåŠ¡å™¨ã€‚')
   	
   		//ç»‘å®šç›‘å¬ï¼Œæ¥æ”¶å®¢æˆ·ç«¯å‘é€è¿‡æ¥çš„æ•°æ®ï¼Œå¹¶ä¸”å¤„ç†æ•°æ®
   		socket.on('sendMsg', function(data){
   			console.log('æœåŠ¡å™¨æ¥æ”¶åˆ°å®¢æˆ·ç«¯å‘é€çš„æ¶ˆæ¯,',data)
   			data.name = data.name.toUpperCase(); //æœåŠ¡å™¨å¤„ç†å®¢æˆ·ç«¯å‘è¿‡æ¥çš„æ•°æ®
   			socket.emit('receiveMsg',data) //æœåŠ¡å™¨å‘å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯,dataæ˜¯å¤„ç†è¿‡åçš„æ•°æ®
   		// io.emit('receiveMsg',data) ä¹Ÿå¯ä»¥ç”¨io.emitæ¥å‘å®¢æˆ·ç«¯åˆ†å‘æ¶ˆæ¯
   		console.log('æœåŠ¡å™¨å‘å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯',data)
   		});
   	})
   }
   ```

   ```javascript
   // bin/www
   
   require('../socketIO/test')(server)//æ­¤å¤„å¾—åˆ°çš„æ˜¯å‡½æ•°ï¼Œå› æ­¤(server)æ‰§è¡Œå®ƒï¼Œå¹¶ä¼ å…¥å‚æ•°server
   ```

2. å®¢æˆ·ç«¯ä»£ç 

   ```javascript
   //  src/test/socketio_test.js
   
   //æ­¤æ¨¡å—æ²¡æœ‰å‘å¤–æš´éœ²ä»€ä¹ˆï¼Œæ‰§è¡Œå®ƒå°±è¡Œäº†ï¼Œè¦æƒ³è®©å®ƒæ‰§è¡Œï¼Œå¯ä»¥å¼•å…¥åˆ°å…¥å£jsæ–‡ä»¶ä¸Š
   import io from "socket.io-client";
   
   //è¿æ¥æœåŠ¡å™¨ï¼Œå¾—åˆ°ä¸æœåŠ¡å™¨çš„é“¾æ¥å¯¹è±¡
   
   const socket = io('ws://localhost:4000');
   
   //å‘é€æ¶ˆæ¯
   socket.emit('sendMsg',{name: "abc"})  //ç¬¬äºŒä¸ªå‚æ•°åªè¦æ˜¯jsæ”¯æŒçš„æ•°æ®ç±»å‹éƒ½å¯ä»¥
   //å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯ï¼Œæ¶ˆæ¯åä¸ºsendMsgï¼Œå‘é€çš„å†…å®¹æ˜¯ä¸€ä¸ªå¯¹è±¡ã€‚æ­¤æ—¶éœ€è¦æœåŠ¡å™¨ç«¯æ¥æ¥å—ï¼Œéœ€è¦è®¾è®¡æœåŠ¡å™¨ç«¯çš„ä»£ç -->
   //å†™å®ŒæœåŠ¡å™¨çš„ä»£ç åï¼Œå›è¿‡æ¥å†™å®¢æˆ·ç«¯çš„ä»£ç 
   console.log('å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘æ¶ˆæ¯', {name: "abc"})
   //ç»‘å®šç›‘å¬ï¼Œæ¥æ”¶æœåŠ¡å™¨å‘é€çš„æ¶ˆæ¯
   socket.on("receiveMsg", function(data){
   	console.log('å®¢æˆ·ç«¯æ¥æ”¶åˆ°æœåŠ¡å™¨å‘é€çš„æ¶ˆæ¯',data)
   })
   ```

   ```javascript
   //. src/index.js
   
   import "./test/socketio_test"; //é¡¹ç›®å…¥å£æ–‡ä»¶å¼•å…¥
   ```

   æ­¤æ—¶åœ¨æœåŠ¡å™¨ç«¯æ–‡ä»¶å¤¹ä¸‹æ‰§è¡Œnpm startï¼Œå®¢æˆ·ç«¯æ–‡ä»¶å¤¹ä¸‹npm startï¼ŒæœåŠ¡å™¨ç«¯ç»ˆç«¯æ˜¾ç¤ºæˆåŠŸè¿æ¥

âœ…ï¼šåŸºç¡€åŠŸèƒ½æµ‹è¯•

è¿›è¡ŒèŠå¤©ç•Œé¢çš„ä»£ç ç¼–å†™ï¼š

1. èŠå¤©ç»„ä»¶åŠŸèƒ½ï¼šchat.jsx

2. æ¶ˆæ¯åˆ—è¡¨ï¼šmessage.jsx.èŠå¤©æ¶ˆæ¯éœ€è¦ç”¨æ•°æ®åº“è¿›è¡Œå­˜å‚¨

3. æœªè¯»æ¶ˆæ¯æ˜¾ç¤ºï¼ŒåŒ…æ‹¬æ€»æ•°é‡çš„æ˜¾ç¤º

   - æ•°æ®åº“çš„ä»£ç ï¼š

     ```javascript
     //æœåŠ¡å™¨ç«¯/db/models.js
     
     //å®šä¹‰chaté›†åˆçš„æ–‡æ¡£ç»“æ„ï¼šåŸºäºschemaç»“æ„å®šä¹‰æ•°æ®æ¨¡å‹
     const chatSchema = mongoose.Schema({
     	from: {type: String, required: true}, //å‘é€ç”¨æˆ·çš„id
     	to: {type: String, required:true}, //æ¥æ”¶ç”¨æˆ·çš„id
     	chat_id: {type: String, required:true}, //èŠå¤©çš„ä¸€å¯¹ä¸€è¿æ¥ï¼Œæ˜¯fromå’Œtoç»„æˆçš„å­—ç¬¦ä¸²ã€‚1å‘ç»™2å’Œ2å‘ç»™1åº”è¯¥æ˜¯ä¸€æ ·çš„å€¼ã€‚
     	content: {type:String, required: true}, //å†…å®¹
     	read: {type: Boolean, default: false}, //æ ‡è¯†æ˜¯å¦å·²è¯»
     	create_time: {type: Number} //åˆ›å»ºæ—¶é—´ã€‚å’Œä¸åŒçš„äººèŠå¤©æœ‰æ’åºï¼Œè¿™ä¸ªæ’åºç”±è¿™ä¸ªå­—æ®µå­˜å‚¨
     });
     //å®šä¹‰èƒ½æ“ä½œchaté›†åˆæ•°æ®çš„Model
     const ChatModel = mongoose.model('chat',chatSchema);
     //å‘å¤–æš´éœ²ChatModel
     exports.ChatModel = ChatModel
     ```

     âœ…ï¼š æ•°æ®åº“éƒ¨åˆ†ä»£ç å®Œæˆ

   - æ–°å¢ä¸¤ä¸ªè·¯ç”±æ¥å£ï¼šroutes/index.js

     ```JavaScript
     //æœåŠ¡å™¨ç«¯ï¼šroutes/index.js
     
     const { UserModel, ChatModel } = require("../db/models"); 
     
     //è·å–å½“å‰ç”¨æˆ·æ‰€æœ‰ç›¸å…³èŠå¤©ä¿¡æ¯åˆ—è¡¨
     /*è¿”å›çš„æ•°æ®åŒ…æ‹¬codeã€dataä¸¤ä¸ªå±æ€§ï¼›dataåŒ…æ‹¬"users"å’Œ"chatMsgs",
     å…¶ä¸­usersæ˜¯å¯¹è±¡{_id1:{},_id2:{},_id3:{}...}ï¼Œä½¿ç”¨å¯¹è±¡çš„ä¼˜ç‚¹æ˜¯å¯ä»¥æ ¹æ®å¯¹è±¡å±æ€§åç«‹åˆ»å¾—åˆ°å±æ€§å€¼ã€‚
     chatMsgsæ˜¯æ•°ç»„[{},{}]*/
     router.get('/msglist',function(req,res){ 
     	const userid = req.cookies.userid;//æŸ¥è¯¢å¾—åˆ°æ‰€æœ‰çš„useræ–‡æ¡£æ•°ç»„
     	UserModel.find(function(err,userDocs){
     		//ç”¨å¯¹è±¡å­˜å‚¨æ‰€æœ‰userä¿¡æ¯ï¼škeyä¸ºuserçš„_idï¼Œvalä¸ºnameå’Œheaderç»„æˆçš„userå¯¹è±¡
     		// const users = {};
     		// userDocs.forEach(doc => {
     		// 	users[doc._id] = {username: doc.username, header:doc.header}
     		// })
     		//å¯ä»¥ç”¨æ•°ç»„çš„é€’å½’å†™æ³•,è¿›è¡Œç´¯åŠ 
     		const users = userDocs.reduce((users,user) => {
     			users[user._id] = {username: user.username, header: user.header}
     			return users;
     		}, {})
     
     		/*æŸ¥è¯¢useridç›¸å…³çš„æ‰€æœ‰èŠå¤©ä¿¡æ¯ï¼š
     		å‚æ•°1: æŸ¥è¯¢æ¡ä»¶
     		å‚æ•°2: è¿‡æ»¤æ¡ä»¶
     		å‚æ•°3: å›è°ƒå‡½æ•°
     		*/
     		ChatModel.find({'$or':[{from: userid}, {to: userid}]}, filter, function(error,chatMsgs){
     			res.send({code:0, data:{users, chatMsgs}}) //dataçš„å€¼æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œæ­¤å¯¹è±¡æœ‰ä¸¤ä¸ªå±æ€§ï¼Œä¸€ä¸ªusersæ˜¯å¯¹è±¡ç±»å‹ï¼Œä¸€ä¸ªchatMsgsæ˜¯æ•°ç»„ç±»å‹
     		})
     		//æ­¤å¤„çš„"$or"è¡¨ç¤ºæŸ¥è¯¢æ¡ä»¶æ˜¯from: useridæˆ–è€…to: userid;filterè¡¨ç¤ºè¿‡æ»¤æ‰passwordï¼›chatMsgsè¡¨ç¤ºå¾—åˆ°èŠå¤©æ¶ˆæ¯çš„æ•°ç»„
     	})
     })
     
     
     //ä¿®æ”¹æŒ‡å®šæ¶ˆæ¯ä¸ºå·²è¯»
     router.post('/readmsg',function(req,res){ //éœ€è¦ä¿®æ”¹æ•°æ®åº“çš„æ•°æ®ã€‚æ‰€æœ‰ç”¨postè¯·æ±‚
     	//å¾—åˆ°è¯·æ±‚ä¸­çš„fromå’Œto
     	const from = req.body.from; //å¯¹æ–¹å‘é€æ•°æ®
     	const to = req.cookies.userid; //è¦ä¿®æ”¹çš„æ˜¯å¯¹æ–¹å‘è¿‡æ¥çš„æ¶ˆæ¯æ˜¾ç¤ºå·²è¯»ï¼Œæ‰€ä»¥ä»cookiesé‡Œæå–è‡ªå·±çš„userid
     	/*æ›´æ–°æ•°æ®åº“ä¸­çš„chatæ•°æ®
     	å‚æ•°1: æŸ¥è¯¢æ¡ä»¶
     	å‚æ•°2: æ›´æ–°ä¸ºæŒ‡å®šçš„æ•°æ®å¯¹è±¡
     	å‚æ•°3: æ˜¯å¦1æ¬¡æ›´æ–°å¤šæ¡ï¼Œé»˜è®¤å€¼æ›´æ–°ä¸€æ¡
     	å‚æ•°4: æ›´æ–°å®Œæˆçš„å›è°ƒå‡½æ•°*/
     	ChatModel.update({from, to, read:false}, {read:true}, {multi:true}, function(err,doc){
     		// updateé»˜è®¤å°†æŸ¥è¯¢ç»“æœåªæ›´æ–°ä¸€æ¬¡ï¼Œå¦‚æœæŸ¥è¯¢åˆ°å¤šæ¡åŒ¹é…é¡¹ï¼Œåªæ›´æ–°ä¸€æ¡ã€‚{multi:true}æŒ‡å®šæ‰€æœ‰åŒ¹é…é¡¹éƒ½æ‰§è¡Œæ›´æ–°æ“ä½œã€‚
     	console.log('/readMsg', doc);
     	res.send({code:0, data: doc.nModified}); //docæœ‰ä¸€ä¸ªnModifiedå±æ€§ï¼Œè¡¨ç¤ºæ›´æ–°çš„æ•°é‡
     	})
     })
     ```

     âœ…ï¼šåå°è·¯ç”±æ¥å£routes/index.jså®Œæˆï¼Œæ³¨å†Œäº†ã€è·å–å½“å‰ç”¨æˆ·æ‰€æœ‰ç›¸å…³èŠå¤©ä¿¡æ¯åˆ—è¡¨ã€‘å’Œã€ä¿®æ”¹æŒ‡å®šæ¶ˆæ¯ä¸ºå·²è¯»ã€‘ä¸¤ä¸ªè·¯ç”±

     å†™å®Œåå°è·¯ç”±æ¥å£ä¹‹åï¼Œæ‰“å¼€postmanè¿›è¡Œæµ‹è¯•ã€‚æ­¤æ—¶è¿˜æ²¡æœ‰æ¶ˆæ¯çš„æ”¶å‘ï¼Œæ²¡æœ‰æ•°æ®ã€‚å¯ä»¥ç­‰åˆ°æœ‰æ•°æ®ä¹‹åå†æµ‹è¯•ã€‚

   - èŠå¤©ç•Œé¢çš„åˆ›å»º

     - å®¢æˆ·ç«¯æ³¨å†ŒèŠå¤©ç•Œé¢å­è·¯ç”±ï¼šcontainers/main/main.jsx

     ```javascript
     // å®¢æˆ·ç«¯/containers/main/main.jsx
     
     import Chat from "../chat/chat";
     
     <Route path="/chat/:userid" component={Chat} />
     ```

     - ç‚¹å‡»è€æ¿/å¤§ç¥åˆ—è¡¨ã€user-listã€‘ä¸­çš„æŸä¸€é¡¹ï¼Œè·³è½¬åˆ°æ¶ˆæ¯ç•Œé¢

     ```javascript
     //components/user-list/user-list.jsx
     <Card onClick={()=>this.props.history.push(`/chat/${user._id}`)}>
     ```

     ç¨‹åºæŠ¥é”™ï¼š![Snip20190805_4](/Users/luofei/Pictures/Snip20190805_4.png)

     åŸå› ï¼šuser-listæ˜¯éè·¯ç”±ç»„ä»¶ï¼Œéœ€è¦ç”¨WithRouteråŒ…è£…ï¼š

     ```JavaScript
     import { withRouter } from "react-router-dom";
     
     export default withRouter(UserList)
     ```

     ä¿®æ”¹å®Œä¹‹åè¿è¡ŒæˆåŠŸã€‚

èŠå¤©ç•Œé¢é™æ€ç»„ä»¶çš„ç¼–å†™ï¼š

```javascript
import '../../assets/css/index.less';

import React, {Component} from "react";
import { NavBar, List, InputItem } from "antd-mobile";
import '../../assets/css/index.less'

const Item = List.Item;

//èŠå¤©ç•Œé¢è·¯ç”±å®¹å™¨
export default class Chat extends Component{
	render(){
		return (
			<div id="chat-page">
				<NavBar>aa</NavBar>
				<List>
					<Item thumb={require(`../../assets/images/å¤´åƒ1.png`)}>ä½ å¥½</Item>
					<Item thumb={require(`../../assets/images/å¤´åƒ1.png`)}>ä½ å¥½2</Item>
					<Item className="chat-me" extra='æˆ‘'>æˆ‘å¾ˆå¥½</Item>
					<Item className="chat-me" extra='æˆ‘'>æˆ‘å¾ˆå¥½2</Item>
				</List>
				<div className="am-tab-bar">
				<InputItem placeholder="è¯·è¾“å…¥" extra={<span>å‘é€</span>} />
				</div>
			</div>
			)
	}
}
```

æ ·å¼ç¼–å†™ï¼š

```css
#chat-page .chat-me .am-list-extra{
	flex-basis: auto;
}
#chat-page .chat-me .am-list-content{
	padding-right: 15px;
	text-align: right;
}
```

- èŠå¤©ç•Œé¢åŠ¨æ€ç»„ä»¶çš„ç¼–å†™ï¼š

  - å‘æ¶ˆæ¯

    - ç‚¹å‡»â€œå‘é€â€æŒ‰é’®ï¼Œæ¶ˆæ¯ä¼šè¢«å‘é€å‡ºå»ï¼Œå¯¹è¯æ¡†å¯ä»¥çœ‹åˆ°æ¶ˆæ¯

    ```javascript
    //containers/chat/chat.jsx
    import { connect } from "react-redux";
    import {} from "../../redux/actions" //å¯¼å…¥å¼‚æ­¥action
    
    	state = {
    		content: ''
    	}
    
    handleSend = ()=>{ //éœ€è¦contentã€fromã€toä¸‰ä¸ªä¿¡æ¯
    		const from = this.props.user._id;
    		const to = this.props.match.params.userid;
    		const content = this.state.content.trim()
    		//å‘é€è¯·æ±‚ï¼ˆå‘æ¶ˆæ¯ï¼‰
    		if (content) {
    			this.props.sendMsg({from, to, content});
    		}
    		//æ¸…é™¤è¾“å…¥æ•°æ®
    		this.setState({content: ''})
    	}
    
    <InputItem 
    				placeholder="è¯·è¾“å…¥" 
    				value={this.state.content}
    				onChange={val => this.setState({content: val})}
    				extra={<span onClick={this.handleSend}>å‘é€</span>} />
    ```

    ```javascript
    //redux/actions.js
    
    //å¼‚æ­¥å‘é€æ¶ˆæ¯çš„å¼‚æ­¥action
    ```

### ã€2019-8-5ã€‘ ä»Šå¤©è§†é¢‘çœ‹è‡³P57ï¼Œä¸‹åˆç”µè„‘æ²¡ç”µï¼Œæ‰‹æœºä¸Šçœ‹äº†ä¸€ç‚¹websoketã€cssè°ƒè¯•çš„å†…å®¹

### ã€2019-8-6ã€‘ ä»Šå¤©ä»P57å¼€å§‹çœ‹

```javascript
// src/test/socketio_test.js

//æ­¤æ¨¡å—æ²¡æœ‰å‘å¤–æš´éœ²ä»€ä¹ˆï¼Œæ‰§è¡Œå®ƒå°±è¡Œäº†ï¼Œè¦æƒ³è®©å®ƒæ‰§è¡Œï¼Œå¯ä»¥å¼•å…¥åˆ°å…¥å£jsæ–‡ä»¶ä¸Š
import io from "socket.io-client";

//è¿æ¥æœåŠ¡å™¨ï¼Œå¾—åˆ°ä¸æœåŠ¡å™¨çš„é“¾æ¥å¯¹è±¡
const socket = io('ws://localhost:4000');
//ç»‘å®šç›‘å¬ï¼Œæ¥æ”¶æœåŠ¡å™¨å‘é€çš„æ¶ˆæ¯
socket.on("receiveMsg", function(data){
	console.log('å®¢æˆ·ç«¯æ¥æ”¶åˆ°æœåŠ¡å™¨å‘é€çš„æ¶ˆæ¯',data)
})

//å‘é€æ¶ˆæ¯
socket.emit('sendMsg',{name: "abc"})  //ç¬¬äºŒä¸ªå‚æ•°åªè¦æ˜¯jsæ”¯æŒçš„æ•°æ®ç±»å‹éƒ½å¯ä»¥
//å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯ï¼Œæ¶ˆæ¯åä¸ºsendMsgï¼Œå‘é€çš„å†…å®¹æ˜¯ä¸€ä¸ªå¯¹è±¡ã€‚æ­¤æ—¶éœ€è¦æœåŠ¡å™¨ç«¯æ¥æ¥å—ï¼Œéœ€è¦è®¾è®¡æœåŠ¡å™¨ç«¯çš„ä»£ç -->
//å†™å®ŒæœåŠ¡å™¨çš„ä»£ç åï¼Œå›è¿‡æ¥å†™å®¢æˆ·ç«¯çš„ä»£ç 
console.log('å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘æ¶ˆæ¯', {name: "abc"})

```

```javascript
// src/redux/action/actions.js

import io from "socket.io-client"; //åœ¨actionsé‡Œå¼•å…¥io
```

```javascript
//socketio_test.jsä¸­çš„ä»£ç :

//è¿æ¥æœåŠ¡å™¨ï¼Œå¾—åˆ°ä¸æœåŠ¡å™¨çš„é“¾æ¥å¯¹è±¡
const socket = io('ws://localhost:4000');
//ç»‘å®šç›‘å¬ï¼Œæ¥æ”¶æœåŠ¡å™¨å‘é€çš„æ¶ˆæ¯
socket.on("receiveMsg", function(data){
	console.log('å®¢æˆ·ç«¯æ¥æ”¶åˆ°æœåŠ¡å™¨å‘é€çš„æ¶ˆæ¯',data)
}) //è¿™æ®µä»£ç åªéœ€åšä¸€æ¬¡å°±å¤Ÿäº†ï¼Œå› æ­¤å¯ä»¥æŠŠå®ƒå°è£…æˆä¸€ä¸ªå‡½æ•°

ä¸Šè¿°ä»£ç åªéœ€æ‰§è¡Œä¸€æ¬¡ï¼Œå› æ­¤å¯ä»¥æŠŠå®ƒåœ¨actionsé‡Œå°è£…æˆä¸€ä¸ªå‡½æ•°
â¬‡ï¸


// src/redux/actions.js
function initIO(){
	//è¿æ¥æœåŠ¡å™¨ï¼Œå¾—åˆ°ä¸æœåŠ¡å™¨çš„é“¾æ¥å¯¹è±¡
	const socket = io('ws://localhost:4000');
	//ç»‘å®šç›‘å¬ï¼Œæ¥æ”¶æœåŠ¡å™¨å‘é€çš„æ¶ˆæ¯
	socket.on("receiveMsg", function(data){
		console.log('å®¢æˆ·ç«¯æ¥æ”¶åˆ°æœåŠ¡å™¨å‘é€çš„æ¶ˆæ¯',data)
	}) //è¿™æ®µä»£ç åªéœ€åšä¸€æ¬¡å°±å¤Ÿäº†ï¼Œå› æ­¤å¯ä»¥æŠŠå®ƒå°è£…æˆä¸€ä¸ªå‡½æ•°
}

//å¼‚æ­¥å‘é€æ¶ˆæ¯çš„å¼‚æ­¥action
export const sendMsg = ({from, to, content}) => {
	return dispatch => {
		console.log('å‘é€æ¶ˆæ¯', {from, to, content})
	}
}
```

æ­¤æ—¶å¦‚æœè¦åœ¨å¼‚æ­¥actioné‡Œè°ƒç”¨initIO()ï¼Œä¼šå¯¼è‡´initIO()è¢«è°ƒç”¨å¤šæ¬¡ã€‚è€Œæˆ‘ä»¬å¸Œæœ›initIO()é‡Œçš„socketåªè¢«åˆ›å»ºä¸€æ¬¡ã€‚å› æ­¤è¿™é‡Œå¯ä»¥ç”¨å•ä¾‹å¯¹è±¡ï¼šåªäº§ç”Ÿä¸€ä¸ªçš„å®ä¾‹å¯¹è±¡ã€‚

- å•ä¾‹å¯¹è±¡ï¼š

  - åˆ›å»ºå¯¹è±¡ä¹‹å‰ï¼Œåˆ¤æ–­å¯¹è±¡æ˜¯å¦å·²ç»åˆ›å»ºã€‚åªæœ‰å¯¹è±¡è¿˜æ²¡æœ‰åˆ›å»ºçš„æ‰å»åˆ›å»º

  - åˆ›å»ºå¯¹è±¡ä¹‹åï¼Œä¿å­˜å¯¹è±¡ã€‚è¿™é‡Œçš„å¯¹è±¡æ˜¯socketã€‚

  - ```javascript
    // src/redux/actions.js
    function initIO(){
    	if (!io.socket) {
    		io.socket = io('ws://localhost:4000');//è¿æ¥æœåŠ¡å™¨ï¼Œå¾—åˆ°ä¸æœåŠ¡å™¨çš„é“¾æ¥å¯¹è±¡.åˆ›å»ºè¯¥å¯¹è±¡ä¹‹åï¼Œä¿å­˜å¯¹è±¡
    		io.socket.on("receiveMsg", function(data){//ç»‘å®šç›‘å¬ï¼Œæ¥æ”¶æœåŠ¡å™¨å‘é€çš„æ¶ˆæ¯
    		console.log('å®¢æˆ·ç«¯æ¥æ”¶åˆ°æœåŠ¡å™¨å‘é€çš„æ¶ˆæ¯',data)
    		}) //è¿™æ®µä»£ç åªéœ€åšä¸€æ¬¡å°±å¤Ÿäº†ï¼Œå› æ­¤å¯ä»¥æŠŠå®ƒå°è£…æˆä¸€ä¸ªå‡½æ•°
    	}
    }
    
    //å¼‚æ­¥å‘é€æ¶ˆæ¯çš„å¼‚æ­¥action
    export const sendMsg = ({from, to, content}) => {
    	return dispatch => {
    		console.log('å‘é€æ¶ˆæ¯', {from, to, content});
    		initIO()
    	}
    }
    ```

  æœåŠ¡å™¨ç«¯åˆ›å»ºsocketIO_server.jsæ–‡ä»¶ï¼š

  ```javascript
  //è¦å¤„ç†æ•°æ®ï¼Œéœ€è¦å¼•ç”¨mongodbæ•°æ®åº“çš„Modelæ¨¡å—
   //æ­¤å¤„çš„serveræ˜¯bin/wwwä¸­å£°æ˜çš„ï¼Œvar server = http.createServer(app);
  //å¼•å…¥å¯¹æ•°æ®çš„å¤„ç†æ¨¡å—Modelï¼š
  const { ChatModel } =require("../db/models")
  
  module.exports = function(server){
  	const io = require('socket.io')(server);
  	//ç›‘è§†å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨çš„é“¾æ¥
  	io.on('connection',function(socket){
  		console.log('æœ‰ä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥ä¸Šäº†æœåŠ¡å™¨ã€‚')
  	
  		//ç»‘å®šç›‘å¬ï¼Œæ¥æ”¶å®¢æˆ·ç«¯å‘é€è¿‡æ¥çš„æ•°æ®ï¼Œå¹¶ä¸”å¤„ç†æ•°æ®
  		socket.on('sendMsg', function({from, to, content}){
  			//å¤„ç†æ•°æ®ã€ä¿å­˜æ¶ˆæ¯ã€‘
  			//å‡†å¤‡chatmessageå¯¹è±¡çš„ç›¸å…³æ•°æ®
  			const chat_id = [from, to].sort().join('_') //å¸Œæœ›from_toæˆ–è€…to_fromçš„ç»“æœä¸€æ ·ã€‚å¯ä»¥ç”¨æ’åºã€‚ä¸¤ä¸ªå­—ç¬¦ä¸²çš„æ’åºç»“æœä¸€è‡´
  			const create_time = Date.now() //åˆ›å»ºå¯¹è¯çš„äº‹ä»¶
  			new ChatModel({from, to, content, chat_id, create_time}).save(function(error, chatMsg){
  				 io.emit('receiveMsg',chatMsg) //ç”¨ioè¡¨ç¤ºå‘æ‰€æœ‰è¿æ¥çš„å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯ã€‚æ•ˆç‡ä¸é«˜ï¼Œä½†ç®€å•ã€‚ç„¶åå†ä»æµè§ˆå™¨ç«¯å±è”½æ‰å’Œè‡ªå·±æ— å…³çš„æ¶ˆæ¯
  			//æ­¤å¤„å‘é€çš„æ˜¯chatMsgï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯actions.jsé‡Œçš„initIO()- - >io.socket.on()é‡Œçš„å‡½æ•°æ¥æ”¶çš„ä¹Ÿåº”è¯¥æ˜¯chatMsg
  			})
  			
  		});
  	})
  }
  ```

  æ›´æ­£bin/wwwé‡Œçš„å¼•ç”¨ï¼š

  ```javascript
  require('../socketIO/socketIO_server.js')(server)//æ­¤å¤„å¾—åˆ°çš„æ˜¯å‡½æ•°ï¼Œå› æ­¤(server)æ‰§è¡Œå®ƒï¼Œå¹¶ä¼ å…¥å‚æ•°server
  ```

  âœ…ï¼šåå°æ¥å£/èŠå¤©é™æ€ç»„ä»¶/å‘é€æ¶ˆæ¯ä¸ä»‹ç»æ¶ˆæ¯çš„åŠŸèƒ½

  postmané‡Œåšâ€œè·å–å½“å‰ç”¨æˆ·ç›¸å…³çš„æ‰€æœ‰èŠå¤©æ¶ˆæ¯â€çš„æ¥å£æµ‹è¯•ï¼Œä¸éœ€è¦è¾“å…¥å‚æ•°ï¼Œç›´æ¥sendã€‚

  æ¥ä¸‹æ¥taskï¼šè·å–æ¶ˆæ¯åˆ—è¡¨æ˜¾ç¤ºï¼š

  1. å‰å°ï¼šsrc/api/index

     ```javascript
     //è·å–å½“å‰ç”¨æˆ·çš„èŠå¤©ä¿¡æ¯åˆ—è¡¨
     export const reqChatMsgList = () =>ajax("/msglist");
     
     //ä¿®æ”¹æŒ‡å®šæ¶ˆæ¯ä¸ºå·²è¯»
     export const reqReadMsg = (from)=>ajax('/readmsg', {from}, 'POST')
     ```

  2. src/redux/reducers.js

     ```javascript
     import { 
     	AUTH_SUCCESS, 
     	ERROR_MSG, 
     	RECEIVE_USER, 
     	RESET_USER, 
     	RECEIVE_USER_LIST,
     	RECEIVE_MSG_LIST,
     	RECEIVE_MSG
     	  } from "./action-types";
     
     //äº§ç”ŸèŠå¤©çŠ¶æ€çš„reducer
     const initChat = {
     	users: {}, //åŒ…å«æ‰€æœ‰ç”¨æˆ·ä¿¡æ¯çš„å¯¹è±¡ï¼›å±æ€§åï¼šuseridï¼Œå±æ€§å€¼æ˜¯ï¼š{username,header}
     	chatMsgs: [], //å½“å‰ç”¨æˆ·æ‰€æœ‰messageç›¸å…³çš„æ•°ç»„
     	unReadCount: 0 //æ€»çš„æœªè¯»æ•°é‡
     }
     function chat(state=initChat, action){
     	switch(action.type){
     		case RECEIVE_MSG_LIST: //data: {users, chatMsgs}
     		const { users, chatMsgs } = action.data;
     		return  {
     			users,
     			chatMsgs,
     			unReadCount: 0
     		}//returnçš„ç»“æ„å¿…é¡»æ˜¯ä¸Šè¿°initChatçš„ç»“æ„
     		case RECEIVE_MSG:
     		return 
     		default:
     		return state;
     	}
     }
     export default combineReducers({ user, userList, chat });
     ```

     src/redux/action-type.js

     ```javascript
     export const RECEIVE_MSG_LIST = "receive_msg_list"; ////æ¥æ”¶æ‰€æœ‰ç›¸å…³æ¶ˆæ¯åˆ—è¡¨
     export const RECEIVE_MSG = "receive_msg"; //æ¥æ”¶ä¸€æ¡æ¶ˆæ¯
     ```

     ç”¨æˆ·ç™»å½•è´¦å·ï¼Œå°±è·å¾—æ¶ˆæ¯åˆ—è¡¨ï¼Œè€Œä¸æ˜¯å¿…é¡»é€šè¿‡user-listæ‰èƒ½è·å–ã€‚åˆ¤æ–­ç”¨æˆ·ç™»å½•çš„æ¡ä»¶ï¼šç”¨æˆ·ç™»å½•loginï¼›ç”¨æˆ·æ³¨å†Œregisterï¼›è·å–åˆ°ç”¨æˆ·ä¿¡æ¯getUser

     ```javascript
     //  src/redux/actions.js
     
     function initIO(){
     	if (!io.socket) {
     		io.socket = io('ws://localhost:4000');//è¿æ¥æœåŠ¡å™¨ï¼Œå¾—åˆ°ä¸æœåŠ¡å™¨çš„é“¾æ¥å¯¹è±¡.åˆ›å»ºè¯¥å¯¹è±¡ä¹‹åï¼Œä¿å­˜å¯¹è±¡
     		io.socket.on("receiveMsg", function(chatMsg){//ç»‘å®šç›‘å¬ï¼Œæ¥æ”¶æœåŠ¡å™¨å‘é€çš„æ¶ˆæ¯
     			console.log('å®¢æˆ·ç«¯æ¥æ”¶åˆ°æœåŠ¡å™¨å‘é€çš„æ¶ˆæ¯',chatMsg)
     		}) //è¿™æ®µä»£ç åªéœ€åšä¸€æ¬¡å°±å¤Ÿäº†ï¼Œå› æ­¤å¯ä»¥æŠŠå®ƒå°è£…æˆä¸€ä¸ªå‡½æ•°
     	}
     }
     //è·å–æ¶ˆæ¯åˆ—è¡¨æ•°æ®çš„å‡½æ•°
     async function getMsgList(dispatch){
     	initIO(); //è¿æ¥æœåŠ¡å™¨è·å–æ¶ˆæ¯åº”è¯¥åœ¨getMsgListä¹‹å‰åš
     	const response = await reqChatMsgList();
     	const result = response.data;
     	if (result.code === 0) {
     		const { users, chatMsg } = result.data;
     		//åˆ†å‘ä¸€ä¸ªåŒæ­¥action
     		dispatch(receiveMsgList({ users, chatMsg }))
     	}
     }
     ```

     è‡³P59ï¼Œå‡ºç°çš„é—®é¢˜ï¼šchromeåå°çš„reduxé‡Œï¼ŒchatMsgsæ²¡æœ‰å†…å®¹ï¼Œæ˜¯ä¸€ä¸ªç©ºæ•°ç»„ã€‚å¯èƒ½æ˜¯æ²¡æœ‰ä¼ å€¼

- æ˜¾ç¤ºæŸä¸ªèŠå¤©ä¿¡æ¯åˆ—è¡¨

  ```javascript
  //containers/chat/chat.jsx
  render(){
      const { user } = this.props;
  		const { users, chatMsgs } = this.props.chat //æ­¤å¤„chatMsgs åŒ…å«çš„æ˜¯â€œæˆ‘â€å’Œæ‰€æœ‰åˆ—è¡¨ç”¨æˆ·çš„èŠå¤©è®°å½•ï¼Œè€Œéœ€è¦çš„åªæ˜¯å’Œå½“å‰ç”¨æˆ·çš„èŠå¤©è®°å½•ï¼Œå› æ­¤éœ€è¦å¯¹chatMsgsè¿›è¡Œè¿‡æ»¤ï¼Œè¿‡æ»¤æ ¹æ®chat_idæ¥è¿‡æ»¤
  		
  		//è®¡ç®—å½“å‰èŠå¤©çš„chat_id
  		const meId = user._id; //ç”¨æˆ·ç«¯çš„id
  		const targetId = this.props.match.params.userid //å½“å‰ç›®æ ‡çš„id
  		const chatId = [targetId, meId].sort().join('_')
  
  		//å¯¹chatMsgè¿›è¡Œè¿‡æ»¤
  		const msgs = chatMsgs.filter(msg => msg.chat_id === chatId);
  		
  		//å¾—åˆ°ç›®æ ‡ç”¨æˆ·å¤´åƒheaderå›¾ç‰‡å¯¹è±¡
  		const targetHeader = users[targetId].header;
  		const targetIcon = targetHeader ? require(`../../assets/images/${targetHeader}.png`) : null;
    
    return (
    ...
      <List>
  				{msgs.map(msg => {
  					if (targetId === msg.from) { //å¯¹æ–¹å‘æ¶ˆæ¯è¿‡æ¥,è¿”å›å·¦è¾¹çš„æ ‡ç­¾
  						return <Item key={msg._id} thumb={targetIcon} >{msg.content}</Item>//å¤´åƒåªéœ€è¦åŠ è½½ä¸€æ¬¡å°±è¡Œäº†
  					}else{ //æ­¤ç«¯å‘æ¶ˆæ¯,è¿”å›å³è¾¹çš„æ ‡ç­¾
  						return <Item key={msg._id} className="chat-me" extra='æˆ‘'>{msg.content}</Item>
  					}
  				})}
  				</List>
    )
  }
  
  export default connect(
  	state => ({user: state.user, chat:state.chat}),
  	{sendMsg}
  	)(Chat)
  ```

  ä»¥ä¸Šä»£ç è¿è¡ŒæŠ¥é”™ï¼š

  ![Snip20190806_5](/Users/luofei/Pictures/Snip20190806_5.png)

åŸå› ï¼š`const targetHeader = users[targetId].header;`é‡Œçš„usersæ­¤æ—¶æ˜¯ä¸€ä¸ªç©ºå¯¹è±¡ï¼Œéœ€è¦åœ¨ç”¨åˆ°usersä¹‹å‰åšä¸€ä¸ªåˆ¤æ–­ï¼Œåˆ¤æ–­æ•°æ®æ˜¯å¦å·²ç»è·å–åˆ°ã€‚

```javascript
if (!users[meId]) {//å¦‚æœè¿˜æ²¡æœ‰è·å–åˆ°æ•°æ®ï¼Œå°±ä¸åšä»»ä½•æ˜¾ç¤ºã€‚usersä¸€å®šç”¨æˆ·å€¼ï¼ŒchatMsgså¯èƒ½æ²¡å€¼
			return null
		}
```

âŒæŠ¥é”™ï¼š

![Snip20190807_1](/Users/luofei/Pictures/Snip20190807_1.png)

è¿˜æ²¡æ‰¾åˆ°åŸå› ã€‚å…ˆç»§ç»­å¾€ä¸‹çœ‹ã€‚

âœ…ï¼šæ‰¾åˆ°åŸå› ï¼š

```javascript
//redux/reducers.js

case RECEIVE_MSG: //è¿”å›çš„dataæ˜¯chatMsg
			const chatMsg = action.data; //ä¹‹å‰è¿™é‡Œçš„chatMsgå†™äº†{}ï¼Œå¯¼è‡´è¿è¡ŒæŠ¥é”™ã€‚ä»€ä¹ˆæ—¶å€™è¯¥åŠ {}ï¼Œä»€ä¹ˆæ—¶å€™ä¸åŠ ï¼Ÿï¼Ÿ
			return {
				users: state.users,
				chatMsgs: [...state.chatMsgs, chatMsg],
				unReadCount: 0
			}
```

`const chatMsg = action.data`æ˜¯å–å‡ºä¼ è¿‡æ¥çš„æ•°æ®ï¼Œå°±æ˜¯chatMsgã€‚

 æ­¤æ—¶çš„â€œè€æ¿â€å’Œâ€œå¤§ç¥â€å¯ä»¥è¿›è¡Œå¯¹è¯äº†ï¼Œä½†æ˜¯ä»æ§åˆ¶å°å¯ä»¥çœ‹åˆ°ï¼Œè€æ¿Aç»™å¤§ç¥Aå‘é€çš„æ¶ˆæ¯ï¼Œå…¶å®ƒæ‰€æœ‰è´¦å·éƒ½èƒ½æ”¶åˆ°ï¼Œåªä¸è¿‡æ²¡æœ‰æ˜¾ç¤ºåœ¨é¡µé¢ä¸Šã€‚

ã€2019-8-7 11:10:00ã€‘P61

###  æ·»åŠ è¡¨æƒ…åŠŸèƒ½

ä¸€ä¸ªè¡¨æƒ…å®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªå­—ç¬¦æ–‡æœ¬ï¼Œå¯ä»¥ç›´æ¥ç”¨å­—ç¬¦ä¸²æ˜¾ç¤ºã€‚è¡¨æƒ…å­—ç¬¦æä¾›çš„ç½‘ç«™ï¼š[https://emojipedia.org](https://emojipedia.org)

å¯ä»¥ç›´æ¥å¤åˆ¶

```javascript
// containers/chat.jsx

<InputItem 
				placeholder="è¯·è¾“å…¥" 
				value={this.state.content}
				onChange={val => this.setState({content: val})}
				extra={
					<span>Grinning Face</span>
					<span onClick={this.handleSend}>å‘é€</span>} />
```

æ­¤å¤„éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œextraå¿…é¡»è¦æœ‰ä¸€ä¸ªè·Ÿæ ‡ç­¾è¿›è¡ŒåŒ…è£¹ã€‚â¬‡ï¸

```javascript
// containers/chat.jsx

<InputItem 
				placeholder="è¯·è¾“å…¥" 
				value={this.state.content}
				onChange={val => this.setState({content: val})}
				extra={
          <span>
              <span>Grinning Face</span>
              <span onClick={this.handleSend}>å‘é€</span>
          </span> } />
```

æ¥ä¸‹æ¥å®ç°åŠŸèƒ½ï¼šç‚¹å‡»è¡¨æƒ…ï¼Œå‡ºç°ä¸€ä¸ªç½‘æ ¼åˆ—è¡¨ï¼Œå¹¶ä¸”åˆ—è¡¨ä¸­çš„è¡¨æƒ…å…ƒç´ å¯é€‰ã€‚ä¸éœ€è¦çš„æ—¶å€™åˆ—è¡¨éšè—.ä»£ç ç¼–å†™é¡ºåºï¼š

- æ”¾ç½®è¡¨æƒ…ä½ç½®ï¼šInputItemçš„extraå±æ€§é‡Œé¢ï¼›æ³¨æ„extraé‡Œçš„å…ƒç´ éœ€è¦ä¸€ä¸ªè·Ÿæ ‡ç­¾è¿›è¡ŒåŒ…è£¹ã€‚

- è®¾ç½®è¡¨æƒ…ç½‘æ ¼æ˜¾ç¤ºçŠ¶æ€ï¼š`state: {isShow: false}`
- å¼•å…¥antd-mobileçš„Gridç»„ä»¶ï¼Œä½¿ç”¨è¯¥ç»„ä»¶çš„dataã€columnNumã€carouselMaxRowï¼ŒisCarouselã€onClickå±æ€§
- å¼•å…¥è¡¨æƒ…æ•°æ®æ•°ç»„ï¼Œè¯¥æ•°ç»„éœ€è¦æå‰å‡†å¤‡å¥½ã€‚å¯ä»¥æ”¾åœ¨componentWillMount()å‡½æ•°é‡Œé¢ï¼Œè¯¥å‡½æ•°åœ¨ç¬¬ä¸€æ¬¡renderæ‰§è¡Œä¹‹å‰æ‰§è¡Œ
- ç‚¹å‡»è¾“å…¥æ¡†å³è¾¹çš„è¡¨æƒ…æ—¶ï¼Œåˆ‡æ¢è¡¨æƒ…ç½‘æ ¼çš„æ˜¾ç¤º/éšè—

```javascript
//containers/chat.jsx

state = {
		content: '',
		isShow: false //æ˜¯å¦æ˜¾ç¤ºè¡¨æƒ…åˆ—è¡¨
	}
Â·Â·Â·

componentWillMount(){ //åœ¨ç¬¬ä¸€æ¬¡renderæ‰§è¡Œä¹‹å‰å›è°ƒï¼Œåœ¨æ­¤åˆå§‹åŒ–è¡¨æƒ…åˆ—è¡¨æ•°æ®
		const emojis = ['ğŸ˜‰', 'ğŸ˜Š', 'ğŸ˜‡', 'ğŸ¥°', 'ğŸ˜', 'ğŸ¤©', 'ğŸ˜˜', 'ğŸ˜—', 'ğŸ˜š', 
		'ğŸ˜™','ğŸ˜‹', 'ğŸ˜›','ğŸ˜', 'ğŸ¤‘', 'ğŸ¤—','ğŸ¤­', 'ğŸ¤«','ğŸ¤”', 'ğŸ¤','ğŸ¤¨','ğŸ˜','ğŸ˜‘',
		'ğŸ˜¶','ğŸ˜','ğŸ˜’','ğŸ™„','ğŸ˜¬','ğŸ¤¥','ğŸ¤’', 'ğŸ¤•','ğŸ¤¢','ğŸ¤®','ğŸ¤§','ğŸ¥µ','ğŸ¥¶','ğŸ¥´',
		'ğŸ˜µ','ğŸ¤¯', 'ğŸ¤ ','ğŸ¥³'] //è¦æ±‚è¯¥æ•°ç»„é‡Œçš„å…ƒç´ æ˜¯å¯¹è±¡ï¼Œå¯¹è±¡æœ‰ä¸€ä¸ªtextå±æ€§ï¼Œtextå±æ€§çš„å€¼æ˜¯è¡¨æƒ…ã€‚
		this.emojis = emojis.map(emoji => ({text: emoji}))
	}

toggleShow =()=>{
		const isShow = !this.state.isShow; //åˆ‡æ¢çŠ¶æ€ï¼Œå³å¯¹å½“å‰çŠ¶æ€å–åã€
		this.setState({isShow});
		if (isShow) {
			//å¼‚æ­¥æ‰‹åŠ¨æ´¾å‘resizeäº‹ä»¶ï¼Œè§£å†³è¡¨æƒ…åˆ—è¡¨æ˜¾ç¤ºçš„bug
			setTimeout(() => {
				window.dispatchEvent(new Event('resize'))
			}, 0);
		} 
	}

...

<InputItem 
				placeholder="è¯·è¾“å…¥" 
				value={this.state.content}
				onChange={val => this.setState({content: val})}
				extra={
					<span>
						<span onClick={this.toggleShow}>ğŸ˜</span>
						<span onClick={this.handleSend}>å‘é€</span>
					</span>} 
					/>
					{this.state.isShow ? (<Grid 
						data={this.emojis} //dataæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œå«æœ‰iconã€textä¸¤ä¸ªå±æ€§
						columnNum={8}
						carouselMaxRow={4}
						isCarousel={true}
						onClick={(item) => {this.setState({content: this.state.content + item.text})}}/>) : null}
				
```

```javascript
//ç‚¹å‡»å‘é€ï¼Œè¡¨æƒ…æ¡†éšè—ï¼š

handleSend = ()=>{ //éœ€è¦contentã€fromã€toä¸‰ä¸ªä¿¡æ¯
		const from = this.props.user._id;
		const to = this.props.match.params.userid;
		const content = this.state.content.trim()
		//å‘é€è¯·æ±‚ï¼ˆå‘æ¶ˆæ¯ï¼‰
		if (content) {
			this.props.sendMsg({from, to, content});
		}
		//æ¸…é™¤è¾“å…¥æ•°æ®
		this.setState({
			content: '',
			isShow: false})
	}

extra={
        <span>
          <span onClick={this.toggleShow}>ğŸ˜</span>
          <span onClick={this.handleSend}>å‘é€</span>
        </span>} 
```

âœ…  è¡¨æƒ…æ¡†ä»£ç å®Œæ¯•ã€‚

### å›ºå®šæ ‡é¢˜æ ï¼›å®ç°èŠå¤©ç•Œé¢æ»‘åŠ¨

1. å›ºå®šæ ‡é¢˜æ 

```javascript
<NavBar className="sticky-header">{users[targetId].username}</NavBar>
<List style={{marginTop:50, marginBottom:50}}>
```

2. å®ç°ç•Œé¢å·¦ä¸Šè§’è¿”å›ï¼š

```javascript
<NavBar 
				icon={<Icon type="left"/>} 
				className="sticky-header"
				onLeftClick={()=>this.props.history.goback()} //ç‚¹å‡»è¿”å›æŒ‰é’®ï¼Œæ‰§è¡Œå›è°ƒå‡½æ•°
				>{users[targetId].username}</NavBar>
```

3. ç‚¹å‡»åˆ°è¯¥ç•Œé¢æ—¶ï¼Œé¡µé¢æ»‘åŠ¨åˆ°åº•éƒ¨;æ¶ˆæ¯å‘é€æˆåŠŸæ—¶ï¼ŒèŠå¤©ç•Œé¢ä¹Ÿæ»‘åŠ¨åˆ°åº•éƒ¨ã€‚

```javascript
componentDidMount(){
		window.scrollTo(0, document.body.scrollHeight);//åˆå§‹åŒ–æ˜¾ç¤ºèŠå¤©åˆ—è¡¨ï¼Œä½¿é¡µé¢æ»‘åŠ¨åˆ°åº•éƒ¨
	}
componentDidUpdate(){
  window.scrollTo(0, document.body.scrollHeight); //æ›´æ–°æ˜¾ç¤ºåˆ—è¡¨
}
```

### æ˜¾ç¤ºæ¶ˆæ¯åˆ—è¡¨

1. æ¶ˆæ¯åˆ—è¡¨é™æ€ç»„ä»¶

   ```javascript
   //containers/messages/messages.jsx
   return (
   			<List style={{marginTop: 50}}>
   				<Item 
   				extra={<Badge text={3} />}
   				thumb={require(`../../assets/images/å¤´åƒ1.png`)} 
   				arrow="horizontal">
   				ä½ å¥½
   				<Brief>nr1</Brief>
   				</Item>
   				<Item 
   				extra={<Badge text={1} />}
   				thumb={require(`../../assets/images/å¤´åƒ2.png`)} 
   				arrow="horizontal">
   				ä½ å¥½2
   				<Brief>nr2</Brief>
   				</Item>
   			</List>
   			)
   ```

2. ä¼ å…¥æ•°æ®ï¼Œè¿›è¡ŒèŠå¤©ä¿¡æ¯çš„åˆ†ç»„

   ```javascript
   export default connect(
   	state => ({user:state.user, chat:state.chat}), //éœ€è¦çš„æ•°æ®ï¼šå½“å‰ç”¨æˆ·åï¼Œå½“å‰èŠå¤©ä¿¡æ¯
   	{}
   	)(Message)
   ```

3. åŠŸèƒ½å‡½æ•°ï¼šæ ¹æ®ä¸æŸä¸ªäººèŠå¤©çš„chat_id,å¯¹chatMsgsè¿›è¡Œåˆ†ç»„

   ```javascript
   function getLastMsgs(chatMsgs){
   	//åŠŸèƒ½å‡½æ•°ï¼šæ ¹æ®ä¸æŸä¸ªäººèŠå¤©çš„chat_id,å¯¹chatMsgsè¿›è¡Œåˆ†ç»„ï¼Œ
   	//å¾—åˆ°æ¯ä¸ªç»„çš„lastMsgç»„æˆçš„æ•°ç»„
   	//1.æ‰¾å‡ºæ¯ä¸ªèŠå¤©çš„lastMsgï¼Œå¹¶ç”¨ä¸€ä¸ªå¯¹è±¡å®¹å™¨æ¥ä¿å­˜{chat_id:lastMsg}
   	const lastMsgObjs = {} //å‡†å¤‡ä¸€ä¸ªç©ºå®¹å™¨
   	chatMsgs.forEach(msg => {
   		const chatId = msg.chat_id; //å¾—åˆ°msgèŠå¤©æ ‡è¯†id
   		const lastMsg = lastMsgObjs[chatId];//è·å–å·²ä¿å­˜çš„å½“å‰ç»„ä»¶çš„lastMsg
   		if (!lastMsg) {//å½“å‰msgå°±æ˜¯æ‰€åœ¨ç»„çš„lastMsg
   			lastMsgObjs[chatId] = msg
   		}else{//å¦‚æœmsgæ¯”lastMsgæ™šï¼Œå°±è®²msgä¿å­˜ä¸ºlastMsg
   			if (msg.create_time > lastMsg.create_time) {
   				lastMsgObjs[chatId] = msg; //å°†msgèµ‹å€¼ç»™lastMsgä¹‹åï¼Œè¦å…³è”åˆ°lastMsgObjsä¸­
   
   			}else{}
   		}
   	})
     
   	//2.å¾—åˆ°æ‰€æœ‰lastMsgçš„æ•°ç»„
   	const lastMsgs = Object.values(lastMsgObjs)//valuesè¿”å›çš„æ•°ç»„æŒ‡å®šæ˜¯å“ªä¸ªå¯¹è±¡
   	
     //3.å¯¹æ•°ç»„æ ¹æ®create_timeè¿›è¡Œé™åºæ’åº
   	lastMsgs.sort(function(m1,m2){//ä¼ å…¥sortä¸€ä¸ªæ’åºå‡½æ•°ï¼Œå¦‚æœç»“æœå°äº0ï¼Œå°†m1æ”¾åœ¨å‰é¢ï¼›ä¸º0é¡ºåºä¸å˜ï¼›å¤§äº0m2åœ¨å‰é¢
   		return  m2.create_time - m1.create_time; //å¦‚æœæ­¤å€¼å°äº0ï¼Œé‚£ä¹ˆm1åœ¨å‰é¢
   	})
   	return lastMsgs
   }
   
   
   
   render(){
   		const { user } = this.props;
   		const { users, chatMsgs } =this.props.chat;
   		const lastMsgs = getLastMsgs(chatMsgs) //è°ƒç”¨å¯¹chatMsgsè¿›è¡Œåˆ†ç»„çš„å‡½æ•°
   ```

   åœ¨renderå‡½æ•°é‡Œé¢æ¸²æŸ“åˆ°ç•Œé¢ä¸Šï¼š

   ```javascript
   const lastMsgs = getLastMsgs(chatMsgs)
   		return (
   			<List style={{marginTop: 50}}>
   			{
   				lastMsgs.map(msg => {
   					const targetUser = msg.to === user._id ? users[msg.from] : users[msg.to]
   					return (
   					<Item 
   						key={msg._id}
   						extra={<Badge text={0} />}
   						thumb={targetUser.header ? require(`../../assets/images/${targetUser.header}.png`) : null} 
   						arrow="horizontal">
   						{msg.content}
   						<Brief>{targetUser.username}</Brief>
   					</Item>
   					)
   				})
   			}
   			</List>
   			)
   ```

âœ…ï¼šèŠå¤©æ¶ˆæ¯åˆ—è¡¨

### ç‚¹å‡»æ¶ˆæ¯åˆ—è¡¨çš„æŸä¸€é¡¹ï¼Œè¿›å…¥èŠå¤©ç•Œé¢

```javascript
  return (
    <List style={{marginTop: 50}}>
    {
      lastMsgs.map(msg => {
        //å¾—åˆ°ç›®æ ‡ç”¨æˆ·id
        const targetUserId = msg.to === user._id ? msg.from : msg.to;
        //å¾—åˆ°ç›®æ ‡ç”¨æˆ·çš„ä¿¡æ¯
        const targetUser = users[targetUserId]
        return (
        <Item 
          key={msg._id}
          extra={<Badge text={0} />}
          thumb={targetUser.header ? require(`../../assets/images/${targetUser.header}.png`) : null} 
          arrow="horizontal"
          onClick={ ()=> this.props.history.push(`/chat/${targetUserId}`)}>
          {msg.content}
          <Brief>{targetUser.username}</Brief>
        </Item>
        )
      })
    }
    </List>
    )
```

âœ…ï¼šåŠŸèƒ½å®Œæˆ

æ˜¾ç¤ºæ¶ˆæ¯åˆ—è¡¨çš„æœªè¯»æ•°é‡ï¼ŒåŒ…æ‹¬æ¯ä¸€è¡Œçš„æœªè¯»æ•°é‡å’Œæ€»çš„æœªè¯»æ•°é‡

1. è®¾è®¡ä¸€ä¸ªå±æ€§unReadCountï¼Œå°†æ­¤msgçš„å±æ€§é€šè¿‡Itemé‡Œçš„extraå±æ€§æ˜¾ç¤ºå‡ºæ¥

```javascript
<Item 
      key={msg._id}

      extra={<Badge text={msg.unReadCount} />}
      
      thumb={targetUser.header ? require(`../../assets/images/${targetUser.header}.png`) : null} 
      arrow="horizontal"
      onClick={ ()=> this.props.history.push(`/chat/${targetUserId}`)}>
      {msg.content}
      <Brief>{targetUser.username}</Brief>
</Item>
```

2. åœ¨ç»Ÿè®¡lastMsgsçš„è¿‡ç¨‹ä¸­ï¼Œç»Ÿè®¡unReadCount

```javascript
chatMsgs.forEach(msg => {
		//å¾€msgä¸ŠåŠ unReadCountå±æ€§ã€‚unReadCountæ˜¯åˆ«äººå‘ç»™â€œæˆ‘â€çš„æœªè¯»æ¶ˆæ¯
		
		//å¯¹msgè¿›è¡Œä¸ªä½“çš„ç»Ÿè®¡ï¼Œçœ‹è¿™ä¸ªä¸ªä½“æ˜¯ä¸æ˜¯æœªè¯»æ¶ˆæ¯ã€‚
		if (msg.to === userid && !msg.read) {
			msg.unReadCount = 1
		}else{
			msg.unReadCount = 0
		}
  
  
if (!lastMsg) {//å½“å‰msgå°±æ˜¯æ‰€åœ¨ç»„çš„lastMsg
			lastMsgObjs[chatId] = msg
		}else{//å¦‚æœmsgæ¯”lastMsgæ™šï¼Œå°±è®²msgä¿å­˜ä¸ºlastMsg
			//ç´¯åŠ unReadCount = å·²ç»ç»Ÿè®¡çš„ + å½“å‰msgçš„
			const unReadCount = lastMsg.unReadCount + msg.unReadCount;
			if (msg.create_time > lastMsg.create_time) {
				lastMsgObjs[chatId] = msg; //å°†msgèµ‹å€¼ç»™lastMsgä¹‹åï¼Œè¦å…³è”åˆ°lastMsgObjsä¸­
			}
			//ç´¯åŠ unReadCountï¼Œå¹¶ä¿å­˜åœ¨æœ€æ–°çš„lastMsgä¸Š:lastMsgObjs[chatId]è¡¨ç¤ºç½ªè¡Œçš„lastMsg
			lastMsgObjs[chatId].unReadCount = unReadCount
		}
  
  //å‡½æ•°ä¼ å…¥å‚æ•°ï¼š
  function getLastMsgs(chatMsgs, userid){
    
  //åœ¨ç»„ä»¶é‡Œè°ƒç”¨æ—¶çš„å‚æ•°ï¼š
  const lastMsgs = getLastMsgs(chatMsgs, user._id)
```

âœ…ï¼š æœªè¯»æ¶ˆæ¯æ•°é‡çš„æ˜¾ç¤º

### æ€»çš„æœªè¯»æ¶ˆæ¯çš„æ˜¾ç¤º

1. readucer.jsxæ–‡ä»¶é‡Œå¯¹unReadCountåšç»Ÿè®¡

   - æ¥æ”¶æ¶ˆæ¯åˆ—è¡¨çš„æ—¶å€™ç»Ÿè®¡å‡ºæ¥æ€»çš„æœªè¯»æ¶ˆæ¯æ•°é‡

     ```javascript
     // redux/reducers.jsx
     case RECEIVE_MSG_LIST: //data: {users, chatMsgs}
     			const { users, chatMsgs, userid } = action.data;
     			return  {
     				users,
     				chatMsgs,
     				unReadCount: chatMsgs.reduce((preTotal, msg) => preTotal + (!msg.read && msg.to===userid ? 1 : 0), 0)
     			}//returnçš„ç»“æ„å¿…é¡»æ˜¯ä¸Šè¿°initChatçš„ç»“æ„
     ```

   - ä¿®æ”¹action.jsé‡Œé¢çš„ä»£ç ï¼š

     ```javascript
     //function initIO(dispatch, userid)å‡½æ•°å†…éƒ¨ï¼š
     dispatch(receiveMsg(chatMsg,userid));
     
     const receiveMsg = (chatMsg, userid)=> ({type: RECEIVE_MSG, data: {chatMsg, userid}})
     ```

   - ä¿®æ”¹reducers.jsé‡Œçš„å¼•ç”¨

     ```javascript
     // redux/reducers.jsx
     case RECEIVE_MSG: //è¿”å›çš„dataæ˜¯chatMsg
     			const {chatMsg, userid} = action.data; //ä¹‹å‰è¿™é‡Œçš„chatMsgå†™äº†{}ï¼Œå¯¼è‡´è¿è¡ŒæŠ¥é”™ã€‚ä»€ä¹ˆæ—¶å€™è¯¥åŠ {}ï¼Œä»€ä¹ˆæ—¶å€™ä¸åŠ ï¼Ÿï¼Ÿ
     			return {
     				users: state.users,
     				chatMsgs: [...state.chatMsgs, chatMsg],
     				unReadCount: state.unReadCount + (!chatMsg.read && chatMsg.to===userid ? 1 : 0) //åˆ¤æ–­æ˜¯ä¸æ˜¯åˆ«äººå‘ç»™æˆ‘çš„æ¶ˆæ¯
     			}
     ```

   âŒ useridåœ¨ä¸¤ä¸ªcaseé‡Œé‡å¤å£°æ˜çš„è§£å†³åŠæ³•ï¼šä¸å¯¹ç¬¬äºŒä¸ªuseridè¿›è¡Œè§£æ„èµ‹å€¼ï¼Œç›´æ¥ç”¨action.data.useridæ¥è¡¨ç¤º

   ```javascript
   reducers.js
   
   case RECEIVE_MSG: //è¿”å›çš„dataæ˜¯chatMsg
   			const {chatMsg} = action.data; //ä¹‹å‰è¿™é‡Œçš„chatMsgå†™äº†{}ï¼Œå¯¼è‡´è¿è¡ŒæŠ¥é”™ã€‚ä»€ä¹ˆæ—¶å€™è¯¥åŠ {}ï¼Œä»€ä¹ˆæ—¶å€™ä¸åŠ ï¼Ÿï¼Ÿ
   			return {
   				users: state.users,
   				chatMsgs: [...state.chatMsgs, chatMsg],
   				unReadCount: state.unReadCount + (!chatMsg.read && chatMsg.to===action.data.userid ? 1 : 0) //åˆ¤æ–­æ˜¯ä¸æ˜¯åˆ«äººå‘ç»™æˆ‘çš„æ¶ˆæ¯
   			}
   ```

2. å†™å¥½reduxé‡Œçš„ä»£ç ä»¥åï¼Œåœ¨nav-footer/nav-footer.jsxé‡Œå°†å…¶æ˜¾ç¤ºå‡ºæ¥

```javascript
	static propTypes = {
		navList: PropTypes.array.isRequired;
    //å°†unReadCountçš„å€¼ä¼ è¿‡æ¥
		unReadCount: PropTypes.number.isRequired
	}

render(){
  //ä»this.propsé‡Œè·å–unReadCountçš„å€¼
		let { navList, unReadCount } = this.props;
  

<Item key={nav.path}
      badge={nav.path==="/message"?3:0} //è¿™é‡Œçš„æ•°å­—3è¦ç”¨unReadCountè¡¨ç¤º
      title={nav.text}
      icon={{uri:require(`./images/${nav.icon}.png`)}} 
      //ç¬¬ä¸€å±‚{}è¡¨ç¤ºè¦å†™jsè¡¨è¾¾å¼ï¼Œç¬¬äºŒå±‚{}è¡¨ç¤ºè¦å†™å¯¹è±¡ï¼Œ``è¡¨ç¤ºå†™çš„æ˜¯ä¸€ä¸ªæ¨¡ç‰ˆå­—ç¬¦ä¸²
      selectedIcon={{uri:require(`./images/${nav.icon}-selected.png`)}}
      selected={ path === nav.path}
      onPress={()=>this.props.history.replace(nav.path)}
      tabBarPosition="bottom"></Item>
```

1. æ‰¾å‡ºä½¿ç”¨nav-footer.jsxç»„ä»¶çš„æ–‡ä»¶ï¼šcontainers/main/main.jsxé‡Œçš„<navFooter>ç»„ä»¶ï¼Œéœ€è¦è¯»å–åˆ°unReadCount

```javascript
//containers/main/main.jsx

//å¦‚æœæœ‰ï¼Œè¯»å–reduxä¸­çš„userçŠ¶æ€ã€‚è¯»å–unReadCountçŠ¶æ€ï¼Œç”¨äºåº•éƒ¨æœªè¯»ä¿¡æ¯çš„æ˜¾ç¤º
const { user, unReadCount } = this.props;

{ currentNav ? <NavFooter navList={navList} unReadCount={unReadCount}/>: null} 
{/*åº•éƒ¨å¯¼èˆªå•ç‹¬æŠ½å–å‡ºæ¥ã€‚*/}

export default connect(
	state => ({user: state.user, unReadCount: state.chat.unReadCount}),
	{ getUser } //å°†getUserä¼ åˆ°å½“å‰çš„UIç»„ä»¶
	)(Main)
```

âœ…ï¼šç»Ÿè®¡åº•éƒ¨æ€»çš„æœªè¯»æ¶ˆæ¯æ•°é‡

### ç‚¹å‡»æœ‰æœªè¯»æ¶ˆæ¯ï¼Œæœªè¯»æ ‡å¿—æ¶ˆå¤±[æ›´æ–°æœªè¯»æ•°é‡]

- ç‚¹å‡»æ¶ˆæ¯åˆ—è¡¨é¡¹ï¼Œè¿›å…¥èŠå¤©ç•Œé¢ï¼Œå°±ä»£è¡¨çœ‹äº†æ¶ˆæ¯ï¼Œæ­¤æ—¶å¯ä»¥æ›´æ–°æœªè¯»æ¶ˆæ¯æ•°é‡ä¸º0
- åœ¨chat.jsxç»„ä»¶é‡Œå†™ï¼Œåœ¨componentDidMount()
- åœ¨actioné‡Œå®šä¹‰readMsg ï¼Œåœ¨action-typeé‡Œå®šä¹‰MSG_READ
- åœ¨action.jsxå¤´éƒ¨å¼•å…¥MSG_READ 
- å®šä¹‰ä¸€ä¸ªè¯»å–äº†æŸä¸ªèŠå¤©æ¶ˆæ¯çš„åŒæ­¥actionï¼šmsgRead
- åœ¨reducers.jsé‡Œå¼•å…¥è¯¥åŒæ­¥actionï¼šcase: MSG_READï¼Œå¹¶å¯¹ç¬¦åˆæ¡ä»¶çš„chatMsgsä¸­çš„æ¯ä¸€é¡¹è¿›è¡Œå¤„ç†
- å¯¹æ–¹å…ˆå‘æ¶ˆæ¯ï¼Œè€Œæˆ‘åç‚¹è¿›å»ï¼Œé‚£ä¹ˆæ˜¾ç¤ºæ¶ˆæ¯æç¤ºï¼›

```javascript
// containers/chat.jsx

import { sendMsg,readMsg } from "../../redux/actions";

conponentDidMount(){
		...
		//å‘è¯·æ±‚æ›´æ–°æ¶ˆæ¯çš„æœªè¯»çŠ¶æ€
		const targetId = this.props.match.params.userid;
		this.props.readMsg(targetId) //è¯»äº†æ¶ˆæ¯ï¼Œé‚£ä¹ˆè¯»äº†è°çš„æ¶ˆæ¯ï¼Ÿå°±éœ€è¦çŸ¥é“ç›®æ ‡ï¼što
  //å¦‚æœæˆ‘å…ˆè¿›å…¥ï¼Œå¯¹æ–¹åå‘ï¼Œé‚£ä¹ˆè¿™æ®µä»£ç åº”è¯¥ä¸æ‰§è¡Œã€‚
	}

export default connect(
	state => ({user: state.user, chat:state.chat}),
	{sendMsg, readMsg}
	)(Chat)
```

```javascript
// redux/action.js
import { 
	MSG_READ //åœ¨action-typeé‡Œå®šä¹‰ä¹‹åï¼Œåœ¨è¿™é‡Œå¼•å…¥
	} from "./action-types";

//è¯»å–æ¶ˆæ¯çš„å¼‚æ­¥action
export const readMsg = (from, to) => {
	return async dispatch => { //ä¸éœ€è¦async/awaitäº†
		const response = await reqReadMsg(from);
		const result = response.data
		if (result.code === 0) {
			//å»å®šä¹‰ä¸€ä¸ªaction-type
			const count = result.data //åå°è¿”å›çš„
			dispatch(msgRead({count, from, to}))
		}
	}
}
//è¯»å–äº†æŸä¸ªèŠå¤©æ¶ˆæ¯çš„åŒæ­¥action
const msgRead = ({count, from, to})=>({type: MSG_READ, data:{count, from, to}})
```

```javascript
// redux/reducers.js

import {MSG_READ} from "./action-types";

function chat(){
  ...
  case MSG_READ:
			const {from, to, count} = action.data;
			return {
				users: state.users,
				chatMsgs: [...state.chatMsgs, chatMsg],
				unReadCount: state.unReadCount - count				
			}
}
```

æ­¤æ—¶éœ€è¦ä¿®æ”¹chatMsgsï¼Œæ‰¾åˆ°æŸä¸€äº›messageï¼ŒæŠŠreadå±æ€§ç”±falseå˜æˆtrue

ç”¨æ•°ç»„çš„mapæ–¹æ³•ã€‚mapæ–¹æ³•ä¸ä¼šæ”¹å˜æ•°ç»„åŸæ•°æ®ï¼Œè€Œæ˜¯äº§ç”Ÿä¸€ä¸ªæ–°çš„æ•°ç»„

```javascript
// redux/reducers.js
case MSG_READ:
			const {from, to, count} = action.data;
			state.chatMsgs.forEach(msg =>{
				if (msg.from===from&&msg.to===to&!msg.read) {
					msg.read = true
				}
			})
			return {
				users: state.users,
				chatMsgs: state.chatMsgs.map(msg => {
					if (msg.from === from&&msg.to===to&&!msg.read) { //éœ€è¦æ›´æ–°
						return {...msg, read: true}
					}else{//ä¸éœ€è¦æ›´æ–°
						return msg
					}
				}),
				unReadCount: state.unReadCount - count				
			}
```

æ·»åŠ ä¸€ä¸ªcomponentWillUnmount()å‡½æ•°ï¼Œç”¨æ¥æ¸…é™¤å¸è½½ç»„ä»¶ä¹‹å‰çš„æ•°æ®ï¼Œå°†componentwillUpdateå‡½æ•°é‡Œçš„ç›¸å…³ä»£ç å¤åˆ¶è¿‡æ¥ã€‚

```javascript
componentWillUnmount(){ //åœ¨é€€å‡ºèŠå¤©ç•Œé¢ã€ä¹Ÿå°±æ˜¯å½“å‰ç»„ä»¶ã€‘ä¹‹å‰æ‰§è¡Œ
	//å‘è¯·æ±‚æ›´æ–°æ¶ˆæ¯çš„æœªè¯»çŠ¶æ€
		const from = this.props.match.params.userid;
		const to = this.props.user._id
		this.props.readMsg(from, to) //è¯»äº†æ¶ˆæ¯ï¼Œé‚£ä¹ˆè¯»äº†è°çš„æ¶ˆæ¯ï¼Ÿå°±éœ€è¦çŸ¥é“ç›®æ ‡ï¼što
	}
```

âŒï¼šè¿™æ ·å¤„ç†çš„ä¸€ä¸ªå°å°çš„é—®é¢˜ï¼šæœªè¯»æ¶ˆæ¯æç¤ºåœ¨é€€å‡ºç•Œé¢çš„ä¸€ç¬é—´ä¼šé—ªä¸€ä¸‹ã€‚

ğŸ““ï¼šè¿™æ˜¯ç”±äºè¦å¼‚æ­¥å‘é€è¯·æ±‚ï¼Œè¯·æ±‚è¿‡ç¨‹ä¸­æœªè¯»æ¶ˆæ¯ä»ç„¶ä¼šæ˜¾ç¤ºã€‚

âœ…ï¼šæ›´æ–°æœªè¯»æ¶ˆæ¯æ•°é‡

### æ·»åŠ èŠå¤©çš„åŠ¨ç”»æ•ˆæœï¼šåˆ‡æ¢é¡µé¢ï¼Œå®ç°é¡µé¢ä»ä¸Šåˆ°ä¸‹æ˜¾ç¤ºçš„æ•ˆæœ

1. åŠ è½½åº“

   ```
   $ sudo cnpm install rc-queue-anim --save
   ```

2. æ‰“å¼€antd-mobileï¼Œåº•éƒ¨çš„antd-motion - -> åŠ¨æ•ˆç»„ä»¶ - ->è¿›å‡ºåœºåŠ¨ç”»ï¼ŒæŸ¥çœ‹æ•ˆæœ

3. API - -> è¿›å‡ºåœºåŠ¨ç”»æŸ¥çœ‹ä½¿ç”¨æ­¥éª¤

4. åœ¨containers/chat/chat.jsxæ–‡ä»¶é‡Œå¼•å…¥è¯¥ç»„ä»¶ï¼Œå¹¶ä¸”è®¾ç½®å±æ€§ï¼Œå®ç°åŠ¨ç”»æ•ˆæœã€‚

5. èŠå¤©ç»„ä»¶æ˜¯é€šè¿‡Liståˆ—è¡¨ï¼Œmapéå†è¿”å›å¤šä¸ªItemçš„æ¨¡å¼ç”Ÿæˆã€‚è€ŒåŠ¨ç”»æ•ˆæœæ˜¯é€šè¿‡<QueueAnim>æ ‡ç­¾å°†æ‰€æœ‰çš„åˆ—è¡¨é¡¹åŒ…è£¹èµ·æ¥ã€‚

   ```javascript
   import QueueAnim from 'rc-queue-anim';
   
   <List style={{marginTop:50, marginBottom:50}}>
       <QueueAnim>
       {/*alpha left right top bottom scale scaleBig scaleX scaleY*/}
         {msgs.map(msg => {
         if (targetId === msg.from) { //å¯¹æ–¹å‘æ¶ˆæ¯è¿‡æ¥,è¿”å›å·¦è¾¹çš„æ ‡ç­¾
           return <Item key={msg._id} thumb={targetIcon} >{msg.content}</Item>//å¤´åƒåªéœ€è¦åŠ è½½ä¸€æ¬¡å°±è¡Œäº†
         }else{ //æ­¤ç«¯å‘æ¶ˆæ¯,è¿”å›å³è¾¹çš„æ ‡ç­¾
           return <Item key={msg._id} className="chat-me" extra='æˆ‘'>{msg.content}</Item>
         }
       })}
       </QueueAnim>
   </List>
   ```

   âœ…ï¼šç”¨antd-mobileçš„rc-queue-animåŠ¨ç”»æ•ˆæœåº“å®Œæˆç»„ä»¶çš„åŠ¨ç”»æ•ˆæœã€‚å¼•å…¥çš„ç»„ä»¶æ ‡ç­¾æ˜¯<QueueAnim>,è¯¥ç»„ä»¶å¯ä»¥ä½¿ç”¨typeå±æ€§ã€åŠ¨ç”»ç±»å‹ã€‘ã€delayå±æ€§ã€åŠ¨ç”»å»¶è¿Ÿæ•ˆæœã€‘ã€durationå±æ€§ã€æ¯ä¸€ä¸ªåŠ¨ç”»çš„æ—¶é—´ã€‘ç­‰ç­‰ã€‚

   âŒï¼šå‡ºç°ä¸€ä¸ªå°é—®é¢˜ï¼šè‹¥æ˜¯ä½¿ç”¨<QueueAnim>æ ‡ç­¾å®ç°åŠ¨ç”»æ•ˆæœï¼Œé‚£ä¹ˆåœ¨è¿›å…¥èŠå¤©é¡µé¢çš„æ—¶å€™ï¼Œæ— æ³•å®šä½åˆ°åº•éƒ¨æœ€æ–°çš„æ¶ˆæ¯å¤„ï¼Œè€Œæ˜¯åœç•™åœ¨å¯¹è¯å¼€å§‹çš„åœ°æ–¹ã€‚

   ğŸ““ï¼šè§£å†³åŠæ³•ï¼š



