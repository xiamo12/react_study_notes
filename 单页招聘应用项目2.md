

# å•é¡µæ‹›è˜åº”ç”¨é¡¹ç›®appã€P40~ã€‘

### ã€2019-8-3  09:26:00ã€‘ä»Šæ—¥è®¡åˆ’ï¼šP40-P50

[TOC]



## æ­å»ºæ•´ä½“ç•Œé¢

## ç”¨æˆ·æ³¨å†Œ/ç™»é™†å¹¶å®Œå–„ä¿¡æ¯ä¹‹åï¼Œè¿›å…¥çš„ç•Œé¢ã€‚

åŠŸèƒ½ï¼š

- åº•éƒ¨åˆ‡æ¢æŒ‰é’®ï¼Œä¸åŒçš„æŒ‰é’®å¯ä¸€åˆ‡æ¢åˆ°ä¸åŒçš„è·¯ç”±ç»„ä»¶ç•Œé¢ã€‚æ ¹æ®ä¸åŒçš„ç±»å‹ï¼Œå‘ˆç°ç›¸åº”çš„ç»„ä»¶é¡µé¢ã€‚

- å®ç°è‡ªåŠ¨ç™»å½•çš„åŠŸèƒ½ã€é€šè¿‡cookieå®ç°ã€‚cookieå½“ä¸­ä¿å­˜æœ‰ç”¨æˆ·id->useridã€‘ã€‚useridé€šè¿‡å‘é€è¯·æ±‚å¾—åˆ°ã€‚

  1.å®ç°è‡ªåŠ¨ç™»å½•ã€‚å¦‚æœcookieä¸­æœ‰useridï¼Œå°±è‡ªåŠ¨ç™»å½•ã€‚è¦å®ç°è‡ªåŠ¨ç™»å½•ï¼Œå°±éœ€è¦å‘è¯·æ±‚ï¼Œè·å–å¯¹åº”çš„user
  2.å¦‚æœcookieä¸­æ²¡æœ‰useridï¼Œå°±è¿›å…¥loginç•Œé¢ã€‚
  3.å¦‚æœå·²ç»ç™»é™†äº†ï¼Œé‚£ä¹ˆå°±åˆ¤æ–­æ˜¯è¿›å…¥å®Œå–„ä¿¡æ¯çš„è·¯ç”±ï¼Œè¿˜æ˜¯è¿›å…¥ä¸»ç•Œé¢è·¯ç”±ã€‚
  å¦‚æœè¯·æ±‚æ ¹è·¯å¾„ï¼Œå°±æ ¹æ®typeå’Œheaderæ¥è®¡ç®—å‡ºä¸€ä¸ªé‡å®šå‘çš„è·¯å¾„ï¼Œè‡ªåŠ¨é‡å®šå‘

- ä¸»é¡µé¢é¡¹ç›®æ­å»ºï¼šåœ¨containers/main/main.jsxå½“ä¸­å®Œæˆ

  - è¯»å–cookieä¸­çš„useridï¼šå¯åŸç”Ÿï¼Œä¹Ÿå¯åŠ è½½ä¾èµ–åŒ…:

    ```
    sudo cnpm install js-cookie -S
    ```

    js-cookieåº“æä¾›äº†ä¸€ä¸ªCookieså¯¹è±¡ï¼Œè¿™æ˜¯ä¸€ä¸ªå¯ä»¥æ“ä½œå‰ç«¯cookieçš„å¯¹è±¡ã€‚æä¾›set()/get()/remove()ç­‰æ–¹æ³•.

    githubåœ°å€ï¼š[js-cookie GitHubåœ°å€](https://github.com/js-cookie/js-cookie)

    ```javascript
    //containers/main/main.jsx
    
    import Cookies from "js-cookie";
    import { getRedirectTo } from "../../utils";
    
        //è¯»å–cookieä¸­userid
    		const userid = Cookies.get('userid');
    		//å¦‚æœæ²¡æœ‰ï¼Œè‡ªåŠ¨é‡å®šå‘åˆ°ç™»é™†ç•Œé¢
    		if (!userid) {
    			return <Redirect to="/login" />
    		}
    		//å¦‚æœæœ‰ï¼Œè¯»å–reduxä¸­çš„userçŠ¶æ€ã€‚
    		const { user } = this.props;
    		//å¦‚æœreduxä¸­userçŠ¶æ€é‡Œæ²¡æœ‰_idï¼Œä¸èƒ½è·³è½¬ç™»é™†ç•Œé¢ï¼Œè€Œæ˜¯è¿”å›ä¸€ä¸ªnullï¼Œä¸åšä»»ä½•æ˜¾ç¤º
    		if (!userid) {
    			return null
    		}else{//å¦‚æœreduxä¸­userçŠ¶æ€é‡Œæœ‰_idï¼Œæ˜¾ç¤ºå¯¹åº”çš„ç•Œé¢
    			const path = this.props.location.pathname;
    			if (path === '/') {//å¦‚æœè¯·æ±‚æ ¹è·¯å¾„ï¼Œå°±æ ¹æ®typeå’Œheaderæ¥è®¡ç®—å‡ºä¸€ä¸ªé‡å®šå‘çš„è·¯å¾„ï¼Œè‡ªåŠ¨é‡å®šå‘
    				//å¾—åˆ°ä¸€ä¸ªé‡å®šå‘çš„è·¯ç”±è·¯å¾„
    				getRedirectTo(user.type, user.header);
    				return <Redirect to={} />
    			}
    		}
    
    ```

  ç”¨Cookies.get("userid")æ—¶æŠ¥é”™ï¼š

  ![Snip20190803_1](/Users/luofei/Pictures/Snip20190803_1.png)

åŸå› ï¼šåœ¨main.jsxæ–‡ä»¶é‡Œå¼•å…¥Cookiesçš„æ—¶å€™é”™è¯¯å¼•ç”¨äº†ã€‚æ­£ç¡®çš„æ ¼å¼åº”è¯¥æ˜¯ï¼š

```javascript
import Cookies from "js-cookie";
```

âœ…ï¼šä¸»ç•Œé¢çš„ç¼–å†™å®Œæˆã€‚

### æœåŠ¡å™¨ç«¯è·¯ç”±ï¼š

```javascript
//åç«¯é¡¹ç›®æ–‡ä»¶/routers/index.js

//è·å–ç”¨æˆ·ä¿¡æ¯çš„è·¯ç”±ï¼Œæ ¹æ®useridè·å–
router.get('/user', function(req,res){
	const userid = req.cookies.userid;
	if (!userid) {
		return res.send({code:1, msg:"è¯·å…ˆç™»é™†"})
	}
	//æ ¹æ®useridæŸ¥è¯¢å¯¹åº”çš„user
	UserModel.findOne({_id: userid}, filter, function(error,user){
		res.send({code:0, data:user});
	})
})
```

### å‰ç«¯apiï¼š

```javascript
//å‰ç«¯é¡¹ç›®æ–‡ä»¶/src/api/index

//è·å–ç”¨æˆ·ä¿¡æ¯
export const reqUser = ()=> ajax('/user')
```

### è·å–ç”¨æˆ·ä¿¡æ¯çš„å¼‚æ­¥action

```javascript
//å‰ç«¯é¡¹ç›®æ–‡ä»¶/src/redux/actions

//è·å–ç”¨æˆ·çš„å¼‚æ­¥action: getUser()
export const getUser = () => {
	return async dispatch => {
		//æ‰§è¡Œå¼‚æ­¥ajaxè¯·æ±‚
		const response = await reqUser(); //reqUser()æ˜¯ä¸€ä¸ªajaxè¯·æ±‚ï¼Œè¯·æ±‚ç»“æœåŒ…æ‹¬{code: xx, data:{}}
		const result = response.data;
		if (result.code === 0) {
			//æˆåŠŸè·å–æ•°æ®
			dispatch(receiveUser(result.data));
		}else{
			//è·å–æ•°æ®å¤±è´¥
			dispatch(resetUser(result.msg))
		}
	}
}
```

### å›åˆ°å‰ç«¯é¡¹ç›®ä»£ç /src/containers/main/main.jsx

```javascript
//src/containers/main/main.jsx

import { getUser } from "../../redux/actions"

//ç»„ä»¶é‡Œçš„componentDidMount()å‡½æ•°
componentDidMount(){
		const userid = Cookies.get('userid');
		const { _id } = this.props.user;
		if (userid && !_id) { //ç™»é™†è¿‡ï¼Œæ‰€ä»¥æœ‰useridï¼›ç°åœ¨æ²¡æœ‰ç™»é™†ï¼Œæ‰€ä»¥æ²¡æœ‰_id
			//å‘é€å¼‚æ­¥è¯·æ±‚ï¼Œè·å–userã€å…ˆå†™ajax->å†å†™redux->å†å†™è¿™ä¸ªç»„ä»¶ã€‘
			this.props.getUser() //ä¸éœ€è¦ä¼ å…¥å‚æ•°
		}
	}

export default connect(
	state => ({user: state.user}),
	{ getUser } //å°†getUserä¼ åˆ°å½“å‰çš„UIç»„ä»¶
	)(Main)

```

### å‰ç«¯è·¯ç”±ç»„ä»¶ã€‚

ä¸€èˆ¬éƒ½è¦è·Ÿreduxäº¤äº’ï¼Œæ‰€ä»¥ä¸€èˆ¬éƒ½æ”¾åœ¨containersæ–‡ä»¶å¤¹é‡Œã€‚

- åˆ›å»ºå››ä¸ªéœ€è¦å’Œreduxäº¤äº’çš„æ–‡ä»¶å¤¹ï¼š
  - containers/laoban/laoban.jsx
  - containers/dashen/dashen.jsx
  - containers/message/message.jsx
  - containers/personal/personal.jsx

- 404ç•Œé¢ã€‚è¿™ä¸ªç•Œé¢ä¸éœ€è¦è·Ÿreduxäº¤äº’ã€‚
  - components/not-found

é¦–å…ˆå†™404ç•Œé¢ï¼š

```javascript
//404é¡µé¢ï¼Œæ‰¾ä¸åˆ°é¡µé¢çš„æ—¶å€™è¿”å›åˆ°è¿™é‡Œã€‚

import React, {Component} from "react";
import { Button } from "antd-mobile"

//å¤§ç¥ç•Œé¢è·¯ç”±å®¹å™¨ä¸»
export default class NotFound extends Component{
	render(){
		return (
			<div>
				<div>
					<h2>æŠ±æ­‰ï¼Œæ‰¾ä¸åˆ°è¯¥é¡µé¢ï¼</h2>
					<Button type="primary" 
					onClick={ ()=>this.props.history.replace('/') }>å›åˆ°é¦–é¡µ</Button>
				</div>
			</div>
			)
	}
}
```

å†å°†å…¶æ˜ å°„åˆ°main.jsxæ–‡ä»¶å½“ä¸­

```javascript
//containers/main/main.jsx
import Dashen from "../dashen/dashen";
import Laoban from "../laoban/laoban";
import Message from "../message/message";
import Personal from "../personal/personal";
import NotFound from "../../components/not-found/not-found";

...

<Switch>
				<Route path="/dasheninfo" component={ DashenInfo } />
				<Route path="/laobaninfo" component={ LaobanInfo } />
				<Route component={ Laoban } />
</Switch>
```

æ¯ä¸ªè·¯ç”±é‡ŒåŒ…å«é‡Œäº”éƒ¨åˆ†ä¿¡æ¯ï¼šè·¯ç”±è·¯å¾„ã€è·¯ç”±ç»„ä»¶ã€åº•éƒ¨å¯¹åº”çš„å›¾æ ‡ã€å›¾æ ‡å¯¹åº”çš„æ–‡å­—ã€é¡¶éƒ¨æ ‡é¢˜ï¼Œè€æ¿/å¤§ç¥çš„è¿™äº”ä¸ªéƒ¨åˆ†ä¿¡æ¯ä¸åŒï¼Œå…¶å®ƒéƒ¨åˆ†ç•Œé¢ç»„æˆç›¸åŒã€‚

- åœ¨main.jsxé‡Œå¼•å…¥è¿™éƒ¨åˆ†ä¿¡æ¯

```javascript
class Main extends Component{
	//ä¸åŠ staticæ˜¯ç»™ç»„ä»¶å¯¹è±¡æ·»åŠ å±æ€§ï¼ŒåŠ staticæ˜¯ç»™ç»„ä»¶ç±»æ·»åŠ å±æ€§
	navList = [ //åŒ…å«æ‰€æœ‰å¯¼èˆªç»„ä»¶çš„ç›¸å…³æ•°æ®ä¿¡æ¯ã€‚
	{
		path: "/laoban",
		component: Laoban,
		title: "å¤§ç¥åˆ—è¡¨",
		icon: "dashen", //
		text: "å¤§ç¥"
	},
	{
		path:"/dashen",
		component: Dashen,
		title: "è€æ¿åˆ—è¡¨",
		icon: "laoban",
		text: "è€æ¿"
	},
	{
		path: "/message",
		component: Message,
		title:"æ¶ˆæ¯åˆ—è¡¨",
		icon: "message",
		text: "æ¶ˆæ¯"
	},
	{
		path: "/personal",
		component: Personal,
		title: "ç”¨æˆ·ä¸­å¿ƒ",
		icon: "personal",
		text: "ä¸ªäºº"
	}
	]
```

- æ˜ å°„è·¯ç”±

  æ¯ä¸ªmainè·¯ç”±ä¸‹é¢çš„å­è·¯ç”±éƒ½æ˜¯ä¸Šã€ä¸­ã€ä¸‹çš„ç»“æ„ï¼ŒåŒ…æ‹¬é¡¶éƒ¨æ ‡é¢˜ã€ä¸­é—´æ˜¯å››ä¸ªå¯¼èˆªè·¯ç”±ç»„ä»¶æ˜¾ç¤ºçš„éƒ¨åˆ†ï¼Œåº•éƒ¨

```javascript
	const  { navList }= this;
		const path = this.props.location.pathname;//è¯·æ±‚çš„è·¯å¾„
		const currentNav = navList.find(nav => nav.path === path) //æ•°ç»„æŸ¥æ‰¾å…ƒç´ ç”¨find()æ–¹æ³•.navListå½“ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ªnavï¼Œæˆ‘ä»¬éœ€è¦å¯¹æ¯”navä¸‹çš„pathæ˜¯ä¸æ˜¯ç­‰äºå½“å‰çš„path 
		//find()ä¸­å¦‚æœä¸ºtrueï¼Œå¾—åˆ°é¦–ä¸ªåŒ¹é…é¡¹ã€‚
		return (<div>
					{ currentNav ? <NavBar>{ currentNav.title }</NavBar> : null}
					<Switch>
					{
						navList.map(nav => <Route path={nav.path} component={nav.component} />) //æ˜ å°„äº†å››ä¸ªè·¯ç”±
					}
						<Route path="/dasheninfo" component={ DashenInfo } />
						<Route path="/laobaninfo" component={ LaobanInfo } />
						<Route component={ Laoban } />
					</Switch>
					{ currentNav ? <div></div> : null} {/*<div></div>æš‚æ—¶å ä½ï¼Œè¿™æ˜¯åº•éƒ¨å¯¼èˆªï¼Œéœ€è¦å•ç‹¬æŠ½å–å‡ºæ¥ã€‚*/}
				</div>)
```

- å®šä¹‰åº•éƒ¨å¯¼èˆªã€åº•éƒ¨å¯¼èˆªä¸éœ€è¦å’Œreduxè¿›è¡Œäº¤äº’ã€‘

  - å®šä¹‰åœ¨components/nav-footer/nav-footer.jsx

  - âš ï¸const path = this.props.location.pathnameï¼šè·¯ç”±ç»„ä»¶æ‰æœ‰è¿™ä¸ªå†™æ³•ï¼Œnav-footer.jsxç»„ä»¶æ˜¯éè·¯ç”±ç»„ä»¶ï¼Œå› æ­¤pathä¸èƒ½ç”¨è¿™ä¸ªæ–¹å¼è·å–ã€‚
  - å¦‚æœå¸Œæœ›åœ¨éè·¯ç”±ç»„ä»¶ä¸­ä½¿ç”¨è·¯ç”±åº“çš„apiï¼Œå¯ä»¥ä½¿ç”¨è·¯ç”±ç»„ä»¶åº“çš„ä¸€ä¸ªå‡½æ•°withRoute()ï¼Œå®ƒå¯ä»¥å¯¹å½“å‰ç»„ä»¶è¿›è¡ŒåŒ…è£…ï¼Œè¿”å›åŒ…è£…åçš„ç»„ä»¶ã€‚

  ```javascript
  //components/nav-footer/nav-footer.jsx
  
  import React, { Component } from "react";
  import { TabBar } from "antd-mobile";
  import PropTypes from "prop-types";
  import { withRouter } from "react-router-dom";
  
  const Item = TabBar.Item
  
  //åº•éƒ¨å®¹å™¨
  class NavFooter extends Component{
  	static propTypes = {
  		navList: PropTypes.array.isRequired
  	}
  	render(){
  		const { navList } = this.props;
  		const path = this.props.location.pathname; //è·¯ç”±ç»„ä»¶æ‰æœ‰è¿™ä¸ªå†™æ³•ï¼Œè¿™ä¸ªç»„ä»¶æ˜¯è·¯ç”±ç»„ä»¶ï¼Œå› æ­¤pathä¸èƒ½ç”¨è¿™ä¸ªæ–¹å¼è·å–
  		//å¸Œæœ›åœ¨éè·¯ç”±ç»„ä»¶ä¸­ä½¿ç”¨è·¯ç”±åº“çš„apiï¼Œå¯ä»¥ä½¿ç”¨è·¯ç”±ç»„ä»¶åº“çš„ä¸€ä¸ªå‡½æ•°withRoute()ï¼Œ
  		//å¯¹å½“å‰ç»„ä»¶è¿›è¡ŒåŒ…è£…ï¼Œè¿”å›åŒ…è£…åçš„ç»„ä»¶
  		return (
  			<TabBar >{ navList.map((nav) => (
  				<Item 
  				key={nav.path}
  				title={nav.text}
  				icon={{uri:require(`./images/${nav.icon}.png`)}} 
  				//ç¬¬ä¸€å±‚{}è¡¨ç¤ºè¦å†™jsè¡¨è¾¾å¼ï¼Œç¬¬äºŒå±‚{}è¡¨ç¤ºè¦å†™å¯¹è±¡ï¼Œ``è¡¨ç¤ºå†™çš„æ˜¯ä¸€ä¸ªæ¨¡ç‰ˆå­—ç¬¦ä¸²
  				selectedIcon={{uri:require(`./images/${nav.icon}-selected.png`)}}
  				selected={ path === nav.path}
  				onPress={()=>this.props.history.replace(nav.path)}
  				tabBarPosition="bottom"></Item>
  				)
  			)
  		}</TabBar>)
  	}
  }
  
  //å†…éƒ¨ä¼šå‘ç»„ä»¶ä¸­ä¼ å…¥ä¸€äº›è·¯ç”±ç»„ä»¶ç‰¹æœ‰çš„å±æ€§ï¼šhistory/location/math
  export default withRouter(NavFooter); //å‘å¤–æš´éœ²withRouter()åŒ…è£…äº§ç”Ÿçš„ç»„ä»¶
  ```

  mainä¸­ä¿å­˜äº†å››ä¸ªäºŒçº§è·¯ç”±ï¼Œä½†æœ‰ä¸€ä¸ªç»„ä»¶éœ€è¦è¢«åŠ¨æ€éšè—ã€‚ç»™å…¶ä¸­ä¸€ä¸ªç»„ä»¶æ·»åŠ éšè—ä¿¡æ¯ã€‚å“ªä¸ªç»„ä»¶è¢«éšè—æ ¹æ®ç”¨æˆ·ç±»å‹å†³å®šã€‚å¦‚æœå½“å‰ç”¨æˆ·ç±»å‹æ˜¯â€œlaobanâ€ï¼Œé‚£ä¹ˆå°±éšè—â€œdashenâ€ç»„ä»¶ã€‚

  nav-footer.jsxç»„ä»¶ç”¨withRouteråŒ…è£…å¹¶å¯¼å‡ºï¼Œå¯ç”¨propsæ¥æ”¶çˆ¶ç»„ä»¶çš„å±æ€§

  ```javascript
  //nav-footer.jsx
  
  let { navList } = this.props; //ä»çˆ¶ç»„ä»¶å½“ä¸­è·å–navList
  //è¿‡æ»¤æ‰hideä¸ºtrueçš„nav
  navList = navList.filter(nav => !nav.hide)
  ```

## ä¸ªäººä¸­å¿ƒåŠŸèƒ½é¡µé¢çš„ç¼–å†™ï¼š

containers/personal/personal.jsx

- ä½¿ç”¨antd-mobileé‡Œçš„UIç»„ä»¶

  ```javascript
  import { Result, List, Button, WhiteSpace } from "antd-mobile";
  ```

- ç”¨connectå°†ç»„ä»¶åŒ…è£…æˆå®¹å™¨ç»„ä»¶

  ```javascript
  export default connect(
  	state => ({user: state.user}),
  	{}
  	)(Personal);
  ```

- é¡µé¢ç»“æ„ï¼š

  ```javascript
  class Personal extends Component{
  	render(){
  		const { username, header, company, post, salary, info } = this.props.user
  		return (
  			<div>
  				<Result 
  					img={<img src={require(`../../assets/images/${header}.png`)} style={{width:50}} alt="header"/>} title={username} message={company} />
  				<List renderHeader={ ()=> "ç›¸å…³ä¿¡æ¯" }>
  					<Item multipleLine> 
  						<Brief>èŒä½ï¼š{post}</Brief>
  						<Brief>ç®€ä»‹ï¼š{info}</Brief>
  						{salary ? <Brief>è–ªèµ„ï¼š{salary}</Brief> : null}
  					</Item>
  				</List>
  				<WhiteSpace/>
  				<List>
  					<Button type="warning">é€€å‡ºç™»å½•</Button>
  				</List>
  			</div>)
  	}
  }
  ```

- é€€å‡ºç™»å½•åŠŸèƒ½çš„ç¼–å†™

  ```
  <Button type="warning" onClick={this.loginOut}>é€€å‡ºç™»å½•</Button>
  ```

  âŒï¼šç‚¹å‡»â€œé€€å‡ºâ€æŒ‰é’®æ—¶ï¼ŒæŒ‰é’®æ²¡æœ‰æ ·å¼ä¸Šçš„ä»»ä½•ååº”ã€‚

  ğŸ““ï¼šåŸå› æ˜¯åº•éƒ¨å¯¼èˆªçš„é«˜åº¦100%ï¼Œè¦†ç›–äº†æ•´ä¸ªé¡µé¢ã€‚å¯¼è‡´ç‚¹å‡»ä¸åˆ°é€€å‡ºæŒ‰é’®ã€‚

  ğŸ“’ï¼šè§£å†³åŠæ³•ï¼šéœ€è¦ä¿®æ”¹assets/css/index.lessæ–‡ä»¶é‡Œçš„`.am-tab-bar`æ ·å¼ï¼Œè®¾ç½®`height:inherit;`

- è¦å®ç°ç‚¹å‡»â€œé€€å‡ºç™»å½•â€æŒ‰é’®ï¼Œè·³å‡ºç¡®è®¤æ¡†ï¼Œè·³è½¬åˆ°ç™»é™†ç•Œé¢ä¸Šçš„åŠŸèƒ½ï¼Œéœ€è¦ä¸€ä¸ªå¯¹è¯æ¡†ç»„ä»¶ï¼šModalã€‚Modalç»„ä»¶ç”±antd-mobileæä¾›ï¼Œå®ƒæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œä¸æ˜¯ä¸€ä¸ªæ ‡ç­¾ã€‚Modalç»„ä»¶æœ‰ä¸€ä¸ªalertæ–¹æ³•ï¼Œæ¥æ”¶ä¸‰ä¸ªå‚æ•°ï¼ŒModal.alert("é€€å‡º", "ç¡®è®¤é€€å‡ºç™»å½•å—ï¼Ÿ", [{},{}])ï¼Œå‰ä¸¤ä¸ªæ˜¯æè¿°ï¼Œç¬¬ä¸‰ä¸ªæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„ç¬¬ä¸€ä¸ªå…ƒç´ æè¿°ç¬¬ä¸€ä¸ªæŒ‰é’®ï¼Œç¬¬äºŒä¸ªå…ƒç´ æè¿°ç¬¬äºŒä¸ªæŒ‰é’®ã€‚

- å¦‚æœä¸éœ€è¦è·Ÿåå°é€šä¿¡ï¼Œé‚£ä¹ˆå°±ç”¨åŒæ­¥actionã€‚resetuserå¯ä»¥ä½¿ç”¨æˆ·çŠ¶æ€å›åˆ°åˆå§‹çŠ¶æ€ã€‚

  ```javascript
  logOut = ()=>{
  		Modal.alert("é€€å‡º", "ç¡®è®¤é€€å‡ºç™»å½•å—ï¼Ÿ", [
  			{
  				text: "å–æ¶ˆ",
  			},
  			{
  				text: "ç¡®è®¤",
  				onPress : ()=>{
  					//ç§»é™¤cookieä¸­çš„userid
  					Cookies.remove("userid");
  					//ç§»é™¤reduxé‡Œç®¡ç†çš„userid
  					this.props.resetUser()
  				}
  			}])
  	}
  ```

âœ…ï¼šâ€œä¸ªäººä¸­å¿ƒâ€è·¯ç”±ç•Œé¢çš„ä»£ç ç¼–å†™å®Œæˆ

## è€æ¿/å¤§ç¥åˆ—è¡¨åŠŸèƒ½çš„ç¼–å†™

containers/laoban/laoban.jsx; 

#### containers/dashen/dashen.jsx 

ä¸¤ä¸ªåˆ—è¡¨åŠŸèƒ½ç±»ä¼¼ï¼Œå¯ä»¥æŠ½å–å‡ºä¸€ä¸ªç»„ä»¶ï¼Œç”¨æ¥å±•ç¤ºç›¸åŒçš„ç»“æ„ã€‚åªè¦æ ¹æ®ç±»åˆ«å¾€é‡Œé¢å¡«å……ä¸åŒåŠŸèƒ½å°±å¯ä»¥äº†ã€‚å› æ­¤æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç”¨æˆ·åˆ—è¡¨ç»„ä»¶ï¼šcomponents/user-list/user-list.jsx

- éœ€è¦ç¼–å†™å±•ç¤ºå¤§ç¥/è€æ¿åˆ—è¡¨çš„é™æ€UIç»„ä»¶ã€‚éœ€æ±‚ï¼šä»åå°è·å–æŒ‡å®šç”¨æˆ·ç±»å‹çš„åˆ—è¡¨ï¼Œæ¸²æŸ“åˆ°é¡µé¢ä¸Š

- é¦–å…ˆç¼–å†™åå°è·¯ç”±routes/index.js

- ```javascript
  //æ ¹æ®typeè·å–å¯¹åº”çš„ç”¨æˆ·åˆ—è¡¨
  router.get('/userlist',function(req,res){
  	const { type } = req.query;
  	UserModel.find({type}, filter, function(error, users){
  		res.send({code: 0, data: users});
  	})
  })
  ```

- åå°è·¯ç”±ç¼–å†™å¥½ä¹‹åï¼Œåœ¨postmanè¿›è¡Œæ¥å£çš„è°ƒè¯•ã€‚é€‰æ‹©â€œGETâ€ç±»å‹ï¼Œâ€œparamsâ€ç±»å‹è¿›è¡Œæµ‹è¯•ã€‚

  âœ…ï¼šå±•ç¤ºå¤§ç¥/è€æ¿åˆ—è¡¨çš„åå°è·¯ç”±æ¥å£ç¼–å†™å®Œæˆï¼ŒåŠŸèƒ½ä¸ºæ ¹æ®typeè·å–å¯¹åº”çš„ç”¨æˆ·åˆ—è¡¨

  ------

- å‰å°apiçš„ç¼–å†™ã€‚æ ¹æ®æ¥å£æ–‡æ¡£å»å®šä¹‰æ¥å£è¯·æ±‚å‡½æ•°

  ```javascript
  //src/api/index.js
  export const reqUserList = (type)=> ajax("/userlist", {type}, "GET");//è¯·æ±‚æ–¹å¼ä¸º"GET"æ—¶å¯çœç•¥
  ```

- userListéœ€è¦ç”¨reduxè¿›è¡Œç®¡ç†ï¼Œå› æ­¤éœ€è¦ç¼–å†™redux

  ```javascript
  //action-types
  export const RECEIVE_USER_LIST = "receive_user_list";
  //ä¹‹å‰çš„actionéƒ½æ˜¯åœ¨æ“ä½œuserï¼Œæ­¤actionæ˜¯æ“ä½œuser-list çš„ï¼Œå› æ­¤éœ€è¦å®šä¹‰å¯¹åº”çš„reducer
  ```

  ```javascript
  //reducer
  //äº§ç”ŸuserlistçŠ¶æ€çš„reducer
  //é€šè¿‡dispatchå¯¹åº”çš„actionæ¥ä¿®æ”¹çŠ¶æ€ï¼Œè€ŒçŠ¶æ€çš„ä¿®æ”¹ç»Ÿä¸€é€šè¿‡reduceræ¥å®Œæˆã€‚
  const initUserList = []
  function userList(state=initUserList, action){
  	switch(action.type){
  		case REVEIVE_USER_LIST: //dataä¸ºuserList
        return action.data
  		default:
  		return state
  	}
  }
  ```

  ```javascript
  //action
  
  //æ¥æ”¶ç”¨æˆ·åˆ—è¡¨çš„åŒæ­¥action
  export const receiveUserList = (userList)=>({type: REVEIVE_USER_LIST, data: userList});
  
  //è·å–ç”¨æˆ·åˆ—è¡¨çš„å¼‚æ­¥action
  export const getUserList = (type)=>{
  	return async dispatch =>{
  		//æ‰§è¡Œå¼‚æ­¥ajaxè¯·æ±‚
  		const response = await reqUserList(type) //reqUserListæ˜¯ä¸€ä¸ªajaxè¯·æ±‚
  		const result = response.data;//responseæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œæ ¼å¼ä¸º{code: 0, data: users}
  		//å¾—åˆ°ç»“æœä¹‹ååˆ†å‘ä¸€ä¸ªåŒæ­¥action
  		if (result.code === 0) {
  			dispatch(receiveUserList(result.data));
  		}
  	}
  }
  ```

  âœ…ï¼šè·å–ç”¨æˆ·åˆ—è¡¨çš„reduxéƒ¨åˆ†ä»£ç å®Œæˆ

  ------

  ### ã€2019-8-4 09:09:00ã€‘

  é¡¹ç›®æ‰“å¼€æµç¨‹ï¼š

  ```
  æ•°æ®åº“mongodbï¼Œæ‰§è¡Œmongodå‘½ä»¤ï¼›
  åç«¯åº”ç”¨é¡¹ç›®ï¼Œæ‰§è¡Œ npm start å‘½ä»¤
  å‰ç«¯åº”ç”¨é¡¹ç›®ï¼Œæ‰§è¡Œ npm start å‘½ä»¤
  ```

- ä¸¤ä¸ªç”¨æˆ·åˆ—è¡¨ç»„ä»¶ï¼šè€æ¿/å¤§ç¥ï¼Œæ ¹æ®typeå®šä¹‰ä¸åŒåˆ—è¡¨ã€‚ä½†æ˜¯åˆ—è¡¨ç»“æ„æ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥å¯ä»¥æŠ½è±¡æˆä¸€ä¸ªç»„ä»¶ã€‚

  - æ–°å»ºcomponnets/users-list/user-list.jsx

    ```javascript
    //æ˜¾ç¤ºæŒ‡å®šç”¨æˆ·åˆ—è¡¨çš„UIç»„ä»¶
    //éœ€è¦æ¥æ”¶ä¸€ä¸ªuser-listå¯¹è±¡
    import React, { Component } from "react";
    // import { connect } from "react-redux";
    import PropTypes from "prop-types";
    import { WingBlank, Card, WhiteSpace } from "antd-mobile";
    const Header = Card.Header;
    const Body = Card.Body;
    
    export default class UserList extends Component{
    	static propTypes = {
    		userList: PropTypes.array.isRequired //æ¥æ”¶ä¸€ä¸ªuserList
    	}
    	render(){
    		const { userList } =this.props;
    		return (
    			<WingBlank>
    			{ userList.map(user =>(
    				<div key={user._id}>
    					<WhiteSpace />
    
    					<Card>
    						<Header thumb={require(`../../assets/images/${user.header}.png`)} extra="username"></Header>
    						<Body>
    							<div>èŒä½ï¼š{user.post}</div>
    							{user.company ? <div>å…¬å¸ï¼š{user.company}</div> : null}
    							{user.salary ? <div>æœˆè–ªï¼š{user.salary}</div> : null}
    							<div>æè¿°ï¼š{user.info}</div>
    						</Body>
    					</Card>
    				</div>
    				)
    			)}
    			</WingBlank>
    			)
    	}
    }
    ```

    æ¸²æŸ“ç•Œé¢çš„æ—¶å€™é‡åˆ°bugï¼š![Snip20190804_2](/Users/luofei/Pictures/Snip20190804_2.png)

æŠ¥é”™ï¼š![Snip20190804_3](/Users/luofei/Pictures/Snip20190804_3.png)

æœ€åå‘ç°æ˜¯åœ¨api/ajax.jsæ–‡ä»¶ä¸­çš„substringæ–¹æ³•æ‹¼å†™é”™è¯¯ï¼Œå†™æˆäº†subStringäº†ã€‚

ã€2019-8-4 13:20:00ã€‘

âœ… bugä¿®å¤

### å®Œå–„åˆ—è¡¨é¡µé¢æ˜¾ç¤º:

âŒï¼šæœ€åä¸€è¡Œçš„æ˜¾ç¤ºä¼šè¢«åº•éƒ¨å¯¼èˆªæ æŒ¡ä½ã€‚

ğŸ““ï¼šç»™åˆ—è¡¨æ‰€åœ¨tagåŠ styleï¼š

```html
<WingBlank style={{marginBottom: 50}}>
```

âŒå¤´éƒ¨ä¼šéšç€é¡µé¢æ»šåŠ¨è€Œæ»šåŠ¨ï¼Œæˆ‘ä»¬éœ€è¦å®ƒå›ºå®š.åŠ style={{marginBottm:50, marginTop:50}}å³å¯è§£å†³é—®é¢˜

âœ…ï¼š ä¿¡æ¯åˆ—è¡¨å®Œæˆ

### å®ç°å®æ—¶èŠå¤©åŠŸèƒ½

1. ä¸‹è½½ç›¸å…³ä¾èµ–åŒ…ï¼šå‰å°åº”ç”¨å’Œåå°åº”ç”¨éƒ½éœ€è¦ä¸‹è½½

   ```
   $ sudo cnpm install socket.io -S
   ```

   - è¿™æ˜¯ä¸€ä¸ªèƒ½å®ç°å¤šäººè¿œç¨‹å®æ—¶é€šä¿¡ã€èŠå¤©ã€‘çš„åº“;

   - å®ƒåŒ…è£…çš„æ˜¯H5 WebSocketã€æ¶‰åŠåˆ°wsåè®®ï¼Œè¯­æ³•ws://ã€‚httpåè®®åªèƒ½å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚ï¼Œä¸èƒ½å®ç°æœåŠ¡å™¨å‘æµè§ˆå™¨å‘é€è¯·æ±‚ã€‚wsåè®®å¯ä»¥å®ç°å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯äº’ç›¸å‘é€è¯·æ±‚ã€‘å’Œè½®è¯¢ã€æµè§ˆå™¨æ¯éš”ä¸€æ®µæ—¶é—´å‘æœåŠ¡å™¨å‘é€è¯·æ±‚ã€‘, å¦‚æœæ˜¯è¾ƒæ–°çš„æµè§ˆå™¨å†…éƒ¨ä½¿ç”¨WebSocketã€‚

     å¦‚æœæµè§ˆå™¨ä¸æ”¯æŒ, é‚£å†…éƒ¨å°±ä¼šä½¿ç”¨è½®è¯¢å®ç°å®æ—¶é€šä¿¡ 

2.  æœåŠ¡å™¨ç«¯åˆ›å»ºä¸€ä¸ªæµ‹è¯•æ–‡ä»¶socketIO/test.js

   æœåŠ¡å™¨ç«¯çš„ioæ˜¯å…¨å±€çš„ï¼Œå…³è”å¾ˆå¤šsocket

   ```javascript
   //   /socketIO/test.js
   module.exports = function (server){
   	//å¾—åˆ°IOå¯¹è±¡
   	const io = require('socket.io')(server); //å¼•ç”¨socket.ioåº“ï¼Œæ‰§è¡Œserverå‡½æ•°å¾—åˆ°io
   	//è§è¯†è¿æ¥ï¼ˆå½“æœ‰ä¸€ä¸ªå®¢æˆ·è¿æ¥ä¸Šæ—¶å›è°ƒï¼‰
   	io.on('connection', function(socket){ //è¿™é‡Œçš„onè¿æ¥ä»»ä½•æµè§ˆå™¨ï¼šå®¢æˆ·ç«¯äº§ç”Ÿè¿æ¥çš„æ—¶å€™æ‰§è¡Œå›è°ƒå‡½æ•°
   		console.log('socketio connected');
   		//ç»‘å®šsendMsgç›‘å¬ï¼Œæ¥æ”¶å®¢æˆ·ç«¯å‘é€çš„æ¶ˆæ¯
   		socket.on('sendMsg', function(data){ //onè¿æ¥çš„æ˜¯æŸä¸€ä¸ªæµè§ˆå™¨ï¼Œè¿™é‡Œçš„sendMsgå¯ä»¥ä»»æ„å‘½å
   			console.log('æœåŠ¡å™¨æ¥æ”¶åˆ°æµè§ˆå™¨çš„æ¶ˆæ¯', data);
   			//å‘å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯ï¼ˆåç§°ï¼Œæ•°æ®ï¼‰
   			io.emit('receiveMsg', data.name+'_'+data.data);//å‘é€ç»™æ‰€æœ‰è¿æ¥ä¸ŠæœåŠ¡å™¨çš„å®¢æˆ·ç«¯
   			//socket.emit('receiveMsg', data.name+'_'+data.data) å‘é€ç»™å½“å‰socketå¯¹åº”çš„å®¢æˆ·ç«¯
         console.log('æœåŠ¡å™¨å‘æµè§ˆå™¨å‘é€æ¶ˆæ¯',data);
   		})
   	})
   }
   
   //è¿™æ˜¯ä¸€ä¸ªå‡½æ•°ç±»å‹çš„æ¨¡å—
   ```

3. æœåŠ¡ç«¯çš„bin/wwwæ–‡ä»¶ä¸‹ï¼š

   ```
   //æ˜¯ä¸€ä¸ªå‡½æ•°ç±»å‹
   require('../socketIO/test')(server);
   ```

4. å®¢æˆ·ç«¯ src/test/socketio_test.js

   ```javascript
   //æ­¤æ¨¡å—æ²¡æœ‰å‘å¤–æš´éœ²ä»€ä¹ˆï¼Œæ‰§è¡Œå®ƒå°±è¡Œäº†ï¼Œè¦æƒ³è®©å®ƒæ‰§è¡Œï¼Œå¯ä»¥å¼•å…¥åˆ°å…¥å£jsæ–‡ä»¶ä¸Š
   import io from "socket.io-client";
   
   const socket = io('ws://localhost:4000');
   socket.on('receiveMsg', function(data){
   	console.log('æµè§ˆå™¨ç«¯æ¥æ”¶åˆ°æ¶ˆæ¯',data);
   });
   
   socket.emit('sendMsg', {name: 'Tom', data: Date.now()});
   console.log('æµè§ˆå™¨ç«¯å‘æœåŠ¡å™¨å‘é€æ¶ˆæ¯:', {name: 'Tom', data:Date.now()})
   ```

5. socketio_testæ¨¡å—æ²¡æœ‰å‘å¤–æš´éœ²ï¼Œå› æ­¤æƒ³è¦æ‰§è¡Œï¼Œå¯ä»¥ç›´æ¥åœ¨å…¥å£jsæ–‡ä»¶é‡Œå¼•ç”¨

   ```javascript
   //src/index.js
   import "./test/socketio_test";
   ```

